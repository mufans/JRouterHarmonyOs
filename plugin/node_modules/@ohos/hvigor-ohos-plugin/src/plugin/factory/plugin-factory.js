"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PluginFactory=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),module_ohos_config_manager_js_1=require("../../common/global/module-ohos-config-manager.js"),common_const_js_1=require("../../const/common-const.js"),global_project_data_service_js_1=require("../../tasks/service/global-project-data-service.js"),ohos_module_task_js_1=require("../../tasks/task/ohos-module-task.js"),legacy_task_initializer_js_1=require("../../utils/legacy-task-initializer.js"),config_file_loader_js_1=require("../../utils/loader/config-file-loader.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),one_sdk_validator_js_1=require("../../utils/one-sdk-validator.js"),project_task_initializer_js_1=require("../../utils/project-task-initializer.js"),resolver_cache_js_1=require("../../utils/resolver/resolver-cache.js"),run_command_util_js_1=require("../../utils/run-command-util.js"),task_initializer_js_1=require("../../utils/task-initializer.js"),app_plugin_js_1=require("../app-plugin.js"),legacy_app_plugin_js_1=require("../legacy/legacy-app-plugin.js"),legacy_plugin_builder_js_1=require("./legacy-plugin-builder.js"),plugin_builder_js_1=require("./plugin-builder.js"),plugin_inspector_js_1=require("./plugin-inspector.js"),path_const_1=require("@ohos/hvigor/src/common/const/path-const"),fs_extra_1=__importDefault(require("fs-extra")),json_util_js_1=require("../../utils/json-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("PluginFactory");class PluginFactory{static getAppPlugin(e,i=!1){config_file_loader_js_1.configFileLoader.clean(),res_model_loader_js_1.resModelLoader.clean(),oh_package_loader_1.ohPackageLoader.clean();const o=i?new legacy_app_plugin_js_1.LegacyAppPlugin(e):new app_plugin_js_1.AppPlugin(e);return o.doProjectInspection(),e.afterBindSystemPlugins((async()=>{var e;o.initGlobalData(),o.initBuildOptionMap(o._project.getBuildProfilePath()),o.initTaskService(),await(null===(e=o.getTaskService())||void 0===e?void 0:e.setup()),o.initContext(),project_task_initializer_js_1.ProjectTaskInitializer.initialize(o,i)})),hvigor_1.hvigorCore.hvigorNodeBeforeEvaluatedInternalHook((()=>{var e;const i=null!==(e=(0,hvigor_2.getAlignTarget)())&&void 0!==e?e:"";if(!this.isOnlyCleanTask()){const e=path_1.default.resolve(path_const_1.HVIGOR_PROJECT_ROOT_DIR,common_const_js_1.CommonConst.OH_PACKAGE_JSON5);let o;if(fs_extra_1.default.existsSync(e)){const i=(0,json_util_js_1.getJson5Obj)(e),a=hvigor_1.hvigorCore.getParameter().getExtParam(common_const_js_1.CommonConst.PARAMETER_FILE);o=null!=a?a:null==i?void 0:i.parameterFile}if(oh_package_loader_1.ohPackageLoader.setIsChangeParameterFile(i,o),oh_package_loader_1.ohPackageLoader.loadUpdatedOhPackageToDisk(i,o),oh_package_loader_1.ohPackageLoader.shouldDoOhpmInstall()){_log.info("start to execute ohpm install");const e=process.env.ohpmBin||"ohpm";if(e&&fs_1.default.existsSync(e)||run_command_util_js_1.RunCommandUtil.run("ohpm -v",void 0,!0)){const a=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_js_1.CommonConst.DEPENDENCYMAP,i);let t;_log.debug(`ohpm install command is "${e}" i --all --target_path ${a}`),t=o?`"${e}" i --all --target_path ${a} --parameterFile=${o}`:`"${e}" i --all --target_path ${a}`,run_command_util_js_1.RunCommandUtil.run(t,void 0,!0)}else _log.warn("need to configure ohpm environment in your system, please see official guide to configure ohpm environment")}}const a=global_project_data_service_js_1.GlobalProjectDataService.getInstance().initProjectPkgJsonFileHash(o.getProjectModel());global_project_data_service_js_1.GlobalProjectDataService.getInstance().setProjectPkgJsonFileHash(a)})),hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook((()=>{var i,a;resolver_cache_js_1.ResolverCache.clear(),null===(i=o.getTaskService())||void 0===i||i.initDependencyInfo(),this.initializeTaskDepends(e,void 0,!1),one_sdk_validator_js_1.OneSdkValidator.apiInspection(o.getProjectModel()),o.initTraceData(),null===(a=o.getTaskService())||void 0===a||a.initProductData()})),o}static getHapPlugin(e,i=!1){let o,a,t;return i?(a=new legacy_plugin_builder_js_1.LegacyPluginBuilder(e),o=a.createFaHapPlugin()):(a=new plugin_builder_js_1.PluginBuilder(e),o=a.createStageHapPlugin()),o.initGlobalData(),a.setUpModulePlugin(o),i?(0,legacy_task_initializer_js_1.legacyHapTasksInitialize)(o):t=task_initializer_js_1.TaskInitializer.initializeHap(o),hvigor_1.hvigorCore.hvigorAfterNodeInternalHook(e.getName(),(async()=>{o.initContext()})),hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook((()=>{var a;null===(a=o.getTaskService())||void 0===a||a.initDependencyInfo(),this.initializeTaskDepends(e,t,i),plugin_inspector_js_1.PluginInspector.checkFeatureEntryModules(o)})),o}static getHarPlugin(e,i=!1){let o,a,t;return i?(a=new legacy_plugin_builder_js_1.LegacyPluginBuilder(e),o=a.createFaHarPlugin()):(a=new plugin_builder_js_1.PluginBuilder(e),o=a.createStageHarPlugin()),o.initGlobalData(),a.setUpModulePlugin(o),i?(0,legacy_task_initializer_js_1.legacyHarTasksInitialize)(o):t=task_initializer_js_1.TaskInitializer.initializeHar(o),hvigor_1.hvigorCore.hvigorAfterNodeInternalHook(e.getName(),(async()=>{o.initContext()})),hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook((()=>{var a;null===(a=o.getTaskService())||void 0===a||a.initDependencyInfo(),plugin_inspector_js_1.PluginInspector.checkAtomicServiceHspModules(o),this.initializeTaskDepends(e,t,i)})),o}static getHspPlugin(e){const i=new plugin_builder_js_1.PluginBuilder(e),o=i.createStageHspPlugin();i.setUpModulePlugin(o);const a=task_initializer_js_1.TaskInitializer.initializeHsp(o);return this.initHspPluginGlobalData(e),hvigor_1.hvigorCore.hvigorAfterNodeInternalHook(e.getName(),(async()=>{o.initContext()})),hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook((()=>{var e;null===(e=o.getTaskService())||void 0===e||e.initDependencyInfo(),a.configure()})),o}static initializeTaskDepends(e,i,o){o||!i?e.getTaskContainer().getAllTasks().filter((e=>e instanceof ohos_module_task_js_1.OhosModuleTask)).forEach((e=>e.initTaskDepends())):null==i||i.configure()}static isOnlyCleanTask(){const e=hvigor_1.hvigor.getCommandEntryTask();return 1===(null==e?void 0:e.length)&&"clean"===e[0]}static initHspPluginGlobalData(e){var i;const o=null===(i=e.getConfigOpt())||void 0===i?void 0:i.getObject("ohos");o&&module_ohos_config_manager_js_1.moduleOhosConfigManager.loaderConfig(e.getName(),o)}}exports.PluginFactory=PluginFactory;