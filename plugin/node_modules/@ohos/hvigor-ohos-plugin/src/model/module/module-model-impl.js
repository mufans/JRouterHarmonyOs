"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModuleModelImpl=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),common_const_js_1=require("../../const/common-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),array_util_js_1=require("../../utils/array-util.js"),log_adaptor_js_1=require("../../utils/log/log-adaptor.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),validate_util_js_1=require("../../utils/validate/validate-util.js"),target_source_set_impl_js_1=require("../source-set/target-source-set-impl.js"),core_module_model_impl_js_1=require("./core-module-model-impl.js"),defaultTargetName=common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET,_log=ohos_logger_js_1.OhosLogger.getLogger("moduleModel");class ModuleModelImpl extends core_module_model_impl_js_1.CoreModuleModelImpl{constructor(e,t){super(e,t),this.initDefaultTargetSourceSet()}getDeviceTypes(){var e;const t=null===(e=this.getSourceSetByTargetName().getModuleTargetRes().getModuleJsonOpt())||void 0===e?void 0:e.module.deviceTypes;return null==t&&_log._buildError("Unable to obtain the module deviceTypes.")._detail("Make sure the module.deviceTypes field is set correctly in the module.json5 file: ")._file(this.getSourceSetByTargetName().getModuleTargetRes().getJsonPath())._printErrorAndExit(),t}initDefaultTargetSourceSet(){const e=new target_source_set_impl_js_1.TargetSourceSetImpl(path_1.default.resolve(this._sourceRootDir,"main"));this.targetSourceSetMap.set(defaultTargetName,e);if((0,array_util_js_1.getElementFromArr)(this.getProfileOpt().targets,ohosTestTargetName)){const e=new target_source_set_impl_js_1.TargetSourceSetImpl(path_1.default.resolve(this._sourceRootDir,ohosTestTargetName));this.targetSourceSetMap.set(ohosTestTargetName,e)}}getModuleType(){const e=this.getSourceSetByTargetName();e||_log._buildError("Invalid exports, no system plugins were found in hvigorfile")._file(`${path_1.default.resolve(this.getProjectDir(),hvigor_1.HvigorCommonConst.BUILD_FILE_NAME)}.ts`)._printErrorAndExit();const t=e.getModuleTargetRes().getModuleJsonOpt();return void 0===t&&_log.printErrorExit(new log_adaptor_js_1.OhosLogAdaptor("HE10009",hvigor_1.globalData.buildId).formatSolutions(0,e.getModuleTargetRes().getJsonPath()).getLogMessage()),void 0===t.module&&_log._buildError("Unable to obtain the module information.")._detail("Make sure the module field is set correctly in the module.json5 file: ")._file(e.getModuleTargetRes().getJsonPath())._printErrorAndExit(),void 0===t.module.type&&_log._buildError("Unable to obtain the module type.")._detail("Make sure the module.type field is set correctly in the module.json5 file: ")._file(e.getModuleTargetRes().getJsonPath())._printErrorAndExit(),module_type_enum_js_1.ModuleType.valueOf(t.module.type)}getSourceSetByTargetName(e=defaultTargetName){return this.targetSourceSetMap.has(e)?this.targetSourceSetMap.get(e):this.targetSourceSetMap.get(defaultTargetName)}getJsonObjByTargetName(e){return this.getSourceSetByTargetName(e).getModuleTargetRes().getModuleJsonOpt()}getJsonPathByTargetName(e){return this.getSourceSetByTargetName(e).getModuleTargetRes().getJsonPath()}isAtomicService(){var e,t;return this.isInstallFree()||(null===(t=null===(e=this.getJsonObjByTargetName(defaultTargetName).module)||void 0===e?void 0:e.extensionAbilities)||void 0===t?void 0:t.some((e=>"form"===e.type)))||!1}isInstallFree(){return this.getJsonObjByTargetName(defaultTargetName).module.installationFree||!1}getFormJsonObjByTargetName(e,t){const o=this.getSourceSetByTargetName(e).getModuleTargetRes().getFormJsonOpt(t);validate_util_js_1.ValidateUtil.validateDuplicatedName(o.forms,"Form",t);const r=path_1.default.resolve(this.getSourceSetByTargetName(e).getModuleTargetRes().getResourcePath(),t);return validate_util_js_1.ValidateUtil.isDefaultCheck(o.forms,r),validate_util_js_1.ValidateUtil.checkUpdateEnable(o.forms,r),o}getPermission(){const e=this.getSourceSetByTargetName().getModuleTargetRes().getModuleJsonOpt();return{requestPermissions:e.module.requestPermissions,definePermissions:e.module.definePermissions}}getCompressNativeLib(){return this.getSourceSetByTargetName().getModuleTargetRes().getModuleJsonOpt().module.compressNativeLibs}}exports.ModuleModelImpl=ModuleModelImpl;