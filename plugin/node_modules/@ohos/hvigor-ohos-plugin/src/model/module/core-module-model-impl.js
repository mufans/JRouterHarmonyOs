"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CoreModuleModelImpl=exports.validProjectPathSet=void 0;const os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),fs_extra_1=__importDefault(require("fs-extra")),ohos_trace_js_1=require("../../common/trace/ohos-trace.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),device_type_const_js_1=require("../../const/device-type-const.js"),compile_mode_enum_js_1=require("../../enum/compile-mode-enum.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),hap_extra_info_js_1=require("../../project/data/hap-extra-info.js"),array_util_js_1=require("../../utils/array-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),error_handlers_js_1=require("../../utils/validate/error-handlers.js"),validate_util_js_1=require("../../utils/validate/validate-util.js"),file_util_js_1=require("../../utils/file-util.js"),module_build_profile_loader_js_1=require("../../utils/loader/file/module-build-profile-loader.js"),oh_package_loader_1=require("../../utils/loader/file/oh-package-loader"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),log=ohos_logger_js_1.OhosLogger.getLogger("ohos-core-module-model");exports.validProjectPathSet=new Set;const invalidBuildProfilePath=new Set;class CoreModuleModelImpl{constructor(e,t){this.compilePluginPath=void 0,this.targetSourceSetMap=new Map,this.module=e,this.name=e.getName(),this.modulePath=e.getNodeDir(),this.parentProject=t,this.buildProfilePath=path_1.default.resolve(this.modulePath,common_const_js_1.CommonConst.PROFILE_JSON5),this.checkModuleBuildProfile(this.buildProfilePath),this.moduleBuildOpt=module_build_profile_loader_js_1.moduleBuildProfileLoader.getBuildProfile(this.name),this._sourceRootDir=path_1.default.resolve(this.modulePath,"src"),this.targets=this.getOrDefaultTargets(),exports.validProjectPathSet.add(this.parentProject.getProjectDir()),this.belongProjectPath=this.initBelongProjectPath(this.modulePath),this.trace()}initBelongProjectPath(e){for(const t of exports.validProjectPathSet)if(e.startsWith(t+path_1.default.sep))return t;const t=this.findBelongProjectPath(e);return exports.validProjectPathSet.add(t),t}findBelongProjectPath(e){if(e===path_1.default.dirname(e))return path_1.default.resolve(this.modulePath,"..");const t=path_1.default.resolve(e,common_const_js_1.CommonConst.PROFILE_JSON5);if(invalidBuildProfilePath.has(t))return this.findBelongProjectPath(path_1.default.dirname(e));if(!fs_extra_1.default.existsSync(t))return invalidBuildProfilePath.add(t),this.findBelongProjectPath(path_1.default.dirname(e));const o=hvigor_1.Json5Reader.getJson5Obj(t);return t&&o.modules?e:(invalidBuildProfilePath.add(t),this.findBelongProjectPath(path_1.default.dirname(e)))}getBelongProjectPath(){return this.belongProjectPath}getCompilePluginPath(){return this.compilePluginPath}setCompilePluginPath(e){this.compilePluginPath=e}refreshData(){this.moduleBuildOpt=module_build_profile_loader_js_1.moduleBuildProfileLoader.getBuildProfile(this.name);this.getOrDefaultTargets().forEach((e=>{const t=this.targets.find((t=>t.name===e.name));if(t)for(const o of Object.keys(e))t[o]=e[o]})),this.trace()}trace(){ohos_trace_js_1.ohosTrace.traceModules(this.name,this.moduleBuildOpt.apiType)}isOhpmProject(){return this.parentProject.isOhpmProject()}isMixedDeviceModule(){return this.getDeviceTypes().some((e=>device_type_const_js_1.DeviceTypeConst.RICH_DEVICES.includes(e)))&&this.getDeviceTypes().some((e=>device_type_const_js_1.DeviceTypeConst.LITE_DEVICES.includes(e)))}isPurerRichDeviceModule(){return this.getDeviceTypes().every((e=>device_type_const_js_1.DeviceTypeConst.RICH_DEVICES.includes(e)))}haveRichDevicesInModule(){return this.getDeviceTypes().some((e=>device_type_const_js_1.DeviceTypeConst.RICH_DEVICES.includes(e)))}haveLiteDevicesInModule(){return this.getDeviceTypes().some((e=>device_type_const_js_1.DeviceTypeConst.LITE_DEVICES.includes(e)))}isPurerLiteDeviceModule(){return this.getDeviceTypes().every((e=>device_type_const_js_1.DeviceTypeConst.LITE_DEVICES.includes(e)))}isSingleDeviceTypeModule(){return this.isPurerRichDeviceModule()||this.isPurerLiteDeviceModule()}getRelatedEntryModules(){if(this.getModuleType()!==module_type_enum_js_1.ModuleType.Feature)return;const e=this.getProfileOpt().entryModules;return this.getApiType()===hap_extra_info_js_1.ApiType.FA&&void 0===e&&log._buildError("'entryModules' must be configured for a feature module in FA project.")._solution("Set 'entryModules' in the build-profile.json5 file.")._file(this.getProfilePath())._printErrorAndExit(this.getName()),null!=e?e:void 0}getSourceRootByTargetName(e=common_const_js_1.DefaultTargetConst.DEFAULT_TARGET){return this.targetSourceSetMap.has(e)?this.targetSourceSetMap.get(e).getSourceSetRoot():this.targetSourceSetMap.get(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET).getSourceSetRoot()}getBuildProfileName(){return common_const_js_1.CommonConst.PROFILE_JSON5}getName(){return this.name}getProjectDir(){return this.modulePath}getParentProject(){return this.parentProject}getPackageJsonPath(){return path_1.default.resolve(this.modulePath,common_const_js_1.CommonConst.PACKAGE_JSON)}getOhPackageJson5Path(){return oh_package_loader_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.modulePath,common_const_js_1.CommonConst.OH_PACKAGE_JSON5))}getProfilePath(){return this.buildProfilePath}getProfileOpt(){return this.moduleBuildOpt}isArkModule(){return!0}isHapModule(){return this.getModuleType()===module_type_enum_js_1.ModuleType.Entry||this.getModuleType()===module_type_enum_js_1.ModuleType.Feature}isHarModule(){return this.getModuleType()===module_type_enum_js_1.ModuleType.Har}isHspModule(){return this.getModuleType()===module_type_enum_js_1.ModuleType.Shared}getProductApiMeta(e){return this.getParentProject().getProductApiMeta(e)}getCompileApiMetaByProduct(e){const t=this.getProductApiMeta(e);if(!t)throw new Error(`Can not find product ${e}.`);return t.compileSdkVersion}getCompatibleApiMetaByProduct(e){const t=this.getProductApiMeta(e);if(!t)throw new Error(`Can not find product ${e}.`);return t.compatibleSdkVersion}getTargetApiMetaByProduct(e){var t;return null===(t=this.getProductApiMeta(e))||void 0===t?void 0:t.targetSdkVersion}getAllModules(){return this.parentProject.getAllModules()}getApiType(){return void 0===this.moduleBuildOpt.apiType?hap_extra_info_js_1.ApiType.STAGE:this.moduleBuildOpt.apiType}getCompileMode(e){const t=this.getCompileApiMetaByProduct(e.name).version;return this.getApiType()===hap_extra_info_js_1.ApiType.FA||t<9?compile_mode_enum_js_1.CompileModeEnum.JS_BUNDLE:compile_mode_enum_js_1.CompileModeEnum.ES_MODULE}getTargetOptions(){return this.targets}getOrDefaultTargets(){const e=this.getProfileOpt().targets;if(void 0===e)return[{name:"default"}];return e.map((e=>e.name)).includes("default")||e.push({name:"default"}),e}moduleBuildProfileCheck(e){const t=e?common_const_js_1.BuildProfileSchemaFileConst.HAP_MODULE_BUILD_PROFILE_SCHEMA_PATH:common_const_js_1.BuildProfileSchemaFileConst.HAR_MODULE_BUILD_PROFILE_SCHEMA_PATH;validate_util_js_1.ValidateUtil.submitSchemaCheckWork({moduleName:this.name,filePath:this.buildProfilePath,schemaPath:t,errorHandlers:[error_handlers_js_1.handleEntryModulesErrors]}),validate_util_js_1.ValidateUtil.validateDuplicatedName(this.getProfileOpt().targets,"targets",this.buildProfilePath),this.validateCompileMode()}checkModuleBuildProfile(e){fs.existsSync(e)||log._buildError("Can not find build config file build-profile.json5.")._file(e)._printErrorAndExit(this.name)}validateCompileMode(){var e;const t=(0,hvigor_1.parseJsonFile)(this.buildProfilePath,!0),o=null===(e=null==t?void 0:t.buildOption)||void 0===e?void 0:e.compileMode;if(o){const e=o._line,t=o._column+1;log.warn(`compileMode has been deprecated. The value of it is invalid.${os_1.default.EOL}         at ${this.buildProfilePath}:${e}:${t}`)}}getModule(){return this.module}processTargetsConfig(){const e=(0,array_util_js_1.getElementFromArr)(this.moduleBuildOpt.targets,"default"),t=(0,array_util_js_1.getElementFromArr)(this.moduleBuildOpt.targets,"ohosTest");void 0!==t&&void 0===t.runtimeOS&&(t.runtimeOS=null==e?void 0:e.runtimeOS)}getWorkerConfig(e){var t,o;return null===(o=null===(t=null==e?void 0:e.sourceOption)||void 0===t?void 0:t.workers)||void 0===o?void 0:o.map((e=>file_util_js_1.FileUtil.convertToAbsolutePath(e,this.getProjectDir())))}getAllTargetSourceSet(){return this.targetSourceSetMap}getJsonProfilePath(e,t=!1){const o=t?common_const_js_1.CommonConst.CONFIG_JSON:common_const_js_1.CommonConst.MODULE_JSON5,r=this.getSourceSetByTargetName(e).getSourceSetRoot();return path_1.default.resolve(r,o)}getJsonProfileOptByTargetName(e,t=!1){const o=this.getJsonProfilePath(e,t);return t?res_model_loader_js_1.resModelLoader.getConfigJson(o):res_model_loader_js_1.resModelLoader.getModuleJson(o)}getJsonProfileByModel(e,t){const o=this.getJsonProfileOptByTargetName(t,e.isFaMode()),r=this.getJsonProfilePath(t,e.isFaMode());return hvigor_1.globalData.cliOpts._.includes(common_const_js_1.CommonConst.ON_DEVICE_TEST)&&!o&&log._buildError(`The path ${r} does not exist, Failed to execute the command ${common_const_js_1.CommonConst.ON_DEVICE_TEST}.`)._printErrorAndExit(),{jsonFilePath:r,profile:o,deviceTypes:e.isFaMode()?o.module.deviceType:o.module.deviceTypes,deviceConfig:e.isFaMode()?common_const_js_1.CommonConst.DEVICE_TYPE:common_const_js_1.CommonConst.DEVICE_TYPES,configurationProfile:e.isFaMode()?common_const_js_1.CommonConst.CONFIG_JSON:common_const_js_1.CommonConst.MODULE_JSON5}}isCrossplatformModule(e){var t;return!!e&&(e.crossplatform&&(null===(t=e.modules)||void 0===t?void 0:t.includes(this.getModule().getName())))}getRemoteHspPath(){return path_1.default.resolve(this.getProjectDir(),common_const_js_1.CommonConst.OH_MODULES,build_directory_const_js_1.BuildArtifactExtension.DOT_HSP)}getMockConfigPath(){return path_1.default.join(this.modulePath,"src","mock",common_const_js_1.CommonConst.MOCK_CONFIG_JSON5)}isOutModule(){return this.parentProject.getProjectDir()!==this.belongProjectPath}}exports.CoreModuleModelImpl=CoreModuleModelImpl;