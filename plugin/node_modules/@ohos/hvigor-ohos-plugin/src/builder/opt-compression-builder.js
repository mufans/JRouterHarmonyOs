"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OptCompressionBuilder=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),glob_1=require("glob"),minimatch_1=__importDefault(require("minimatch")),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),copy_resources_util_js_1=require("../utils/copy-resources-util.js"),_log=hvigor_1.HvigorLogger.getLogger("opt-compression-builder"),UNIT_TO_SIZE_NUMBER=Object.freeze({k:1024,K:1024,m:1048576,M:1048576,t:1073741824,T:1073741824});class OptCompressionBuilder{constructor(){this.optCompressionObj={context:{extensionPath:""},compression:{media:{enable:!1},sizeLimit:void 0,filters:[]}},this.allResourceFilesAbsolutePath=[]}setResourceDirArr(e){const o=e.map((e=>path_1.default.resolve(e,common_const_js_1.CommonConst.GLOB_MATCH_ALL_FILES)));return this.allResourceFilesAbsolutePath=glob_1.glob.sync(o,{nodir:!0,absolute:!0,windowsPathsNoEscape:!0}),this}setExtensionPath(e){return this.optCompressionObj.context.extensionPath=null!=e?e:"",this}setCompressionConfig(e){var o,t,i;return this.optCompressionObj.compression.filters=this.convertFilters(null!==(o=null==e?void 0:e.filters)&&void 0!==o?o:[]),void 0!==(null===(t=null==e?void 0:e.media)||void 0===t?void 0:t.enable)&&(this.optCompressionObj.compression.media=e.media),void 0!==(null===(i=null==e?void 0:e.sizeLimit)||void 0===i?void 0:i.ratio)&&(this.optCompressionObj.compression.sizeLimit=e.sizeLimit),this.checkMediaFilter(),this}getOptCompressionObj(){return this.optCompressionObj}processSize(e){return null==e?void 0:e.map((e=>e.map((e=>{if("number"==typeof e)return e;const o=e.length-1,t=e.charAt(o);if(Object.prototype.hasOwnProperty.call(UNIT_TO_SIZE_NUMBER,t)){const i=UNIT_TO_SIZE_NUMBER[t];return parseInt(e.slice(0,o))*i}return parseInt(e)})))).filter((([e,o=Number.POSITIVE_INFINITY])=>!(e>o)||(_log.warn("Invalid compression filter size will be ignored: ",[e,o]),!1))).sort(((e,o)=>e[0]-o[0])).reduce(((e,o)=>{const t=e.length>0?e[e.length-1]:void 0;return t&&1===t.length?e:!t||t[1]<o[0]-1?(e.push(o),e):1===o.length?(e[e.length-1]=[t[0]],e):(t[1]=Math.max(t[1],o[1]),e)}),[])}processResolution(e){return null==e?void 0:e.filter((e=>{const[o,t={width:Number.POSITIVE_INFINITY,height:Number.POSITIVE_INFINITY}]=e;return!(o.width>t.width||o.height>t.height)||(_log.warn("Invalid compression filter resolution will be ignored: ",[...e]),!1)}))}getPathFromResourceFiles(e){if(e)return this.allResourceFilesAbsolutePath.filter((o=>e.some((e=>{const t=(0,copy_resources_util_js_1.toUnixPath)(e);return(0,minimatch_1.default)(o,t)}))))}convertRules(e){if(e&&(e.size||e.resolution))return{size:this.processSize(e.size),resolution:this.processResolution(e.resolution)}}convertFilters(e){return e.map((e=>{var o,t,i,s,r;const l={method:(0,wdk_1.cloneDeep)(e.method),path:this.getPathFromResourceFiles(null===(o=e.files)||void 0===o?void 0:o.path),exclude_path:this.getPathFromResourceFiles(null===(t=e.exclude)||void 0===t?void 0:t.path),rules_origin:this.convertRules(e.files),rules_exclude:this.convertRules(e.exclude)};return(null===(i=e.exclude)||void 0===i?void 0:i.path)||(null===(s=e.exclude)||void 0===s?void 0:s.size)||(null===(r=e.exclude)||void 0===r?void 0:r.resolution)||(l.exclude_path=[]),l}))}checkMediaFilter(){var e,o,t;const i=null!==(o=null===(e=this.optCompressionObj.compression.media)||void 0===e?void 0:e.enable)&&void 0!==o&&o,s=!(null===(t=this.optCompressionObj.compression.filters)||void 0===t?void 0:t.length);i&&s&&this.optCompressionObj.compression.filters.push({method:{type:"sut",blocks:"4x4"}})}}exports.OptCompressionBuilder=OptCompressionBuilder;