"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildOptionManager=exports.BuildModeManager=void 0;const hvigor_1=require("@ohos/hvigor"),find_target_product_js_1=require("../../common/find-target-product.js"),build_mode_const_js_1=require("../../const/build-mode-const.js"),common_const_js_1=require("../../const/common-const.js"),task_names_js_1=require("../../tasks/common/task-names.js"),array_util_js_1=require("../../utils/array-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),build_option_util_js_1=require("./build-option-util.js"),build_option_util_js_2=require("./build-option-util.js"),path_1=require("path"),build_option_path_info_js_1=require("../../common/build-option-path-info.js"),module_ohos_config_manager_js_1=require("../../common/global/module-ohos-config-manager.js"),log=ohos_logger_js_1.OhosLogger.getLogger("BuildModeManager"),BUILD_OPTION_MERGE_ARRAY_KEYS=Object.freeze(["resOptions.compression.filters"]);class BuildModeManager{constructor(){this.productBuildOptionMap=new Map,this.targetBuildOptionMap={}}initProjectBuildOptions(i,o){var t,e,n;this.productBuildOptionMap.clear();const l=BuildModeManager.getBuildMode();let u=new Map;build_option_util_js_2.BuildOptionUtil.validateBuildMode(l,i);const d=hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.DEBUGGABLE);log.debug(`Start initialize project's product build option map with build mode ${l}.`);const _=i.getProfileOpt(),r=_.app.products;let s=null!==(t=_.app.buildModeSet)&&void 0!==t?t:[];s=build_option_util_js_2.BuildOptionUtil.arrayDeduplication(s);const p=null!==(n=null===(e=(0,array_util_js_1.getElementFromArr)(s,l))||void 0===e?void 0:e.buildOption)&&void 0!==n?n:{};r.forEach((t=>{var e;let n={};d&&(p.debuggable="true"===hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.DEBUGGABLE));const _=null!==(e=t.buildOption)&&void 0!==e?e:{};log.debug(`Picking option from product '${t.name}' with build mode '${l}'.`),n=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(_,n,BUILD_OPTION_MERGE_ARRAY_KEYS),u=build_option_util_js_1.BuildOptionCombiner.mergeBuildOptionPath(n,o,u),n=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(p,n,BUILD_OPTION_MERGE_ARRAY_KEYS),u=build_option_util_js_1.BuildOptionCombiner.mergeBuildOptionPath(n,o,u);const r=build_option_util_js_2.BuildOptionUtil.getDefaultBuildModeBuildOpt(l);n=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(r,n,BUILD_OPTION_MERGE_ARRAY_KEYS),u=build_option_util_js_1.BuildOptionCombiner.mergeBuildOptionPath(n,o,u);const s=(0,path_1.dirname)(i.getProfilePath());this.convertCompressionPathToAbsolute(n,s),log.debug(`Product '${t.name}' build option: ${JSON.stringify(p,null,"  ")}`),build_option_path_info_js_1.buildOptionPath.setProductOptPath(u,t.name),this.productBuildOptionMap.set(t.name,n)})),log.debug(`End initialize project's product build option map with build mode '${l}'.`)}initModuleBuildOptions(i,o){var t,e,n;const l=i.getName(),u=BuildModeManager.getBuildMode();build_option_util_js_2.BuildOptionUtil.validateBuildMode(u,i.getParentProject()),this.targetBuildOptionMap[l]?this.targetBuildOptionMap[l].clear():this.targetBuildOptionMap[l]=new Map;const d=i.getParentProject().getProfileOpt(),_=build_option_util_js_2.BuildOptionUtil.arrayDeduplication(null!==(t=d.app.buildModeSet)&&void 0!==t?t:[]),r=i.getProfileOpt(),s=build_option_util_js_2.BuildOptionUtil.getOrDefaultBuildModeBinderSet(null!==(e=r.buildModeBinder)&&void 0!==e?e:[]);let p=null!==(n=r.buildOptionSet)&&void 0!==n?n:[];log.debug(`Start initialize module-target build option map, moduleName=${l}, buildMode=${u}`),p=build_option_util_js_2.BuildOptionUtil.arrayDeduplication(p),build_option_util_js_1.BuildOptionCombiner.processCopyFrom(p),i.getTargetOptions().forEach((t=>{var e,n,d,a,g,m,b;let O={},B=new Map;const c=(0,find_target_product_js_1.findTargetProduct)(i.getParentProject());hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.DEBUGGABLE)&&(O.debuggable="true"===hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.DEBUGGABLE));const h=module_ohos_config_manager_js_1.moduleOhosConfigManager.getBuildOption(l);O=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(h,O,BUILD_OPTION_MERGE_ARRAY_KEYS),B=build_option_util_js_1.BuildOptionCombiner.mergeBuildOptionPath(O,`${i.getModule().getBuildFilePath()}.ts`,B);const j=null!==(n=null===(e=t.config)||void 0===e?void 0:e.buildOption)&&void 0!==n?n:{};log.debug(`Target '${t.name}' config: ${JSON.stringify(j,null,"  ")}`),O=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(j,O,BUILD_OPTION_MERGE_ARRAY_KEYS),B=build_option_util_js_1.BuildOptionCombiner.mergeBuildOptionPath(O,o,B);const E=this.getBuildOptNameFromMapping(s,u,t.name),M=null!==(d=(0,array_util_js_1.getElementFromArr)(p,E))&&void 0!==d?d:{};O=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(M,O,BUILD_OPTION_MERGE_ARRAY_KEYS),B=build_option_util_js_1.BuildOptionCombiner.mergeBuildOptionPath(O,o,B),O=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(null!==(a=r.buildOption)&&void 0!==a?a:{},O,BUILD_OPTION_MERGE_ARRAY_KEYS),B=build_option_util_js_1.BuildOptionCombiner.mergeBuildOptionPath(O,o,B);const v=null!==(g=c.buildOption)&&void 0!==g?g:{};this.convertCompressionPathToAbsolute(v,i.getBelongProjectPath()),O=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(v,O,BUILD_OPTION_MERGE_ARRAY_KEYS);const P=build_option_path_info_js_1.buildOptionPath.getProductOptPath(c.name);B=build_option_util_js_1.BuildOptionCombiner.mergeProductBuildOptionPath(null!=P?P:new Map,B);const C=null!==(b=null===(m=(0,array_util_js_1.getElementFromArr)(_,u))||void 0===m?void 0:m.buildOption)&&void 0!==b?b:{};this.convertCompressionPathToAbsolute(C,i.getBelongProjectPath()),O=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(C,O,BUILD_OPTION_MERGE_ARRAY_KEYS),B=build_option_util_js_1.BuildOptionCombiner.mergeBuildOptionPath(O,o,B);const f=build_option_util_js_2.BuildOptionUtil.getDefaultModuleBuildOpt(E);O=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(f,O,BUILD_OPTION_MERGE_ARRAY_KEYS);const A=build_option_util_js_2.BuildOptionUtil.getDefaultBuildModeBuildOpt(u);O=build_option_util_js_1.BuildOptionCombiner.mergeBuildOption(A,O,BUILD_OPTION_MERGE_ARRAY_KEYS),build_option_path_info_js_1.buildOptionPath.setBuildOptionPath(l,t.name,B);const R=(0,path_1.dirname)(i.getProfilePath());this.convertCompressionPathToAbsolute(O,R),this.targetBuildOptionMap[l].set(t.name,O)})),this.targetBuildOptionMap[l].forEach(((i,o)=>{log.debug(`Module '${l}' target '${o}' build option: ${JSON.stringify(i,null,"  ")}`)})),log.debug(`End initialize module-target build option map, moduleName=${l}`)}getBuildOptNameFromMapping(i,o,t){var e,n;const l=null!==(n=(null!==(e=i.find((i=>{if(i.buildModeName===o)return i})))&&void 0!==e?e:{}).mappings)&&void 0!==n?n:[];for(const i of l)if(i.targetName===t)return i.buildOptionName;switch(log.debug(`Does not get target '${t}'corresponding build option.`),o){case build_mode_const_js_1.BuildModeConst.DEBUG:case build_mode_const_js_1.BuildModeConst.TEST:return log.debug("Using preset build option 'debug'."),build_mode_const_js_1.BuildOptionConst.DEBUG;case build_mode_const_js_1.BuildModeConst.RELEASE:return log.debug("Using preset build option 'release'."),build_mode_const_js_1.BuildOptionConst.RELEASE;default:return log.debug("Using preset build option 'default'."),build_mode_const_js_1.BuildOptionConst.DEFAULT}}getProductBuildOption(i){var o;const t=null!==(o=this.productBuildOptionMap.get(i))&&void 0!==o?o:{};return log.debug(`Product '${i}' using build option: ${JSON.stringify(t,null,"  ")} in this build.`),t}getTargetBuildOption(i,o){var t,e;const n=null!==(e=null===(t=this.targetBuildOptionMap[i])||void 0===t?void 0:t.get(o))&&void 0!==e?e:{};return log.debug(`Module '${i}' target '${o}' using build option: ${JSON.stringify(n,null,"  ")} in this build.`),n}static getBuildMode(){const i=hvigor_1.hvigorCore.getExtraConfig().get("buildMode");return i||(hvigor_1.hvigorCore.isCommandEntryTask(task_names_js_1.TaskNames.CommonHookTask.ASSEMBLE_APP.name)?build_mode_const_js_1.BuildModeConst.RELEASE:build_mode_const_js_1.BuildModeConst.DEBUG)}convertCompressionPathToAbsolute(i,o){var t,e,n;null===(n=null===(e=null===(t=i.resOptions)||void 0===t?void 0:t.compression)||void 0===e?void 0:e.filters)||void 0===n||n.forEach((i=>{var t,e;(null===(t=i.files)||void 0===t?void 0:t.path)&&(i.files.path=this.convertPathToAbsolute(i.files.path,o)),(null===(e=i.exclude)||void 0===e?void 0:e.path)&&(i.exclude.path=this.convertPathToAbsolute(i.exclude.path,o))}))}convertPathToAbsolute(i,o){return i.map((i=>i.startsWith(common_const_js_1.CommonConst.SUB_DIR_PREFIX)?(0,path_1.resolve)(o,i):i))}}exports.BuildModeManager=BuildModeManager,exports.buildOptionManager=new BuildModeManager;