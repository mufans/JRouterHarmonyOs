"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getEntryPath=exports.getEntryMainFilePath=exports.DependencyManager=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),common_util_js_1=require("../../common/common-util.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),legacy_module_model_impl_js_1=require("../../model/module/legacy-module-model-impl.js"),core_project_model_impl_js_1=require("../../model/project/core-project-model-impl.js"),har_extend_info_js_1=require("../../tasks/har/har-extend-info.js"),error_url_js_1=require("../../utils/error-url.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),base_package_resolver_js_1=require("../../utils/resolver/base-package-resolver.js"),npm_package_resolver_js_1=require("../../utils/resolver/npm-package-resolver.js"),ohpm_package_resolver_js_1=require("../../utils/resolver/ohpm-package-resolver.js"),dependency_builder_js_1=require("./core/dependency-builder.js"),dependency_interface_js_1=require("./core/dependency-interface.js"),module_dependency_info_js_1=require("./module-dependency-info.js"),log=ohos_logger_js_1.OhosLogger.getLogger("ohos-dependency-manager"),solution=`The OpenHarmony npm package or module is not compatible with the current model. Use a compatible OpenHarmony npm package or module. For details about the stage and FA models, see ${error_url_js_1.ErrorUrl.ERROR_URL.modelDiff}.`,json5Map=hvigor_1.hvigorCore.getCache("JSON_CACHE");function getJson5Obj(e){var n;const o=fs_1.default.statSync(e).mtime.getTime();return(null===(n=json5Map.get(e))||void 0===n?void 0:n.timeStamp)!==o&&json5Map.set(e,{timeStamp:o,fileContent:hvigor_1.Json5Reader.getJson5Obj(e)}),json5Map.get(e).fileContent}class DependencyManager{constructor(e,n,o){this._allDependency=new Set,this._model=n,this._projectModel=o,this._moduleName=n.getName(),this._isFaMode=e,this._isOhpmDependency=this.isOhpmDependency()}isOhpmDependency(){return this._projectModel?this._projectModel.isOhpmProject():this._model.isOhpmProject()}createModelDependencyInfo(){const e=(e,n,o)=>n&&e.npm.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DEV_DEPENDENCIES||o&&e.npm.getDependencyType()!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP,n=this._isOhpmDependency?this._model.getOhPackageJson5Path():this._model.getPackageJsonPath(),{npmDependencies:o,moduleDependencyMap:t,modulePkgNode:s,projectPkgNode:d}=this.getDependenciesByFilter(this._model,n,e,e);return log.debug(`Module ${this._moduleName} Collected Dependency: ${o.map((e=>e.getDependencyRootPath()))}`),log.debug(`Module ${this._moduleName}'s total dependency: ${o.length}`),new module_dependency_info_js_1.ModuleDependencyInfo(this.buildSelfDependency(this._model,n),s,d,t,o)}buildSelfDependency(e,n){const o=e instanceof core_project_model_impl_js_1.CoreProjectModelImpl,t=o?e.getProject():e.getModule(),s=getJson5Obj(n),d=this.getHarmonyDependencyType(n,s,n,t.getName());let l;o||(l=[path_1.default.resolve(e.getProjectDir(),"src/main/module.json5"),path_1.default.resolve(e.getProjectDir(),"src/main/module.json")].find((e=>fs_1.default.existsSync(e))));const r=(new dependency_builder_js_1.DependencyBuilder).setDependencyName(t.getName()).setDependencyRootPath(t.getNodeDir()).setPkgJsonPath(n).setPkgJsonObj(s).setIsLocal(!0).setModule(t).setModuleJsonObj(this.getModuleJsonObj(l)).setDependencyEnum(dependency_interface_js_1.DependencyEnum.DEPENDENCIES);return d&&r.setDependencyType(d),r.buildDefaultModuleDependency()}collectAllDependencies(){const e=this._isOhpmDependency?this._model.getOhPackageJson5Path():this._model.getPackageJsonPath();return this.getDependenciesByFilter(this._model,e,void 0,((e,n,o)=>o||e.npm.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DEV_DEPENDENCIES))}collectAllDependenciesForPkgInfo(){const e=this._isOhpmDependency?this._model.getOhPackageJson5Path():this._model.getPackageJsonPath();return this.getDependenciesByFilter(this._model,e,((e,n)=>{var o;return n||(null===(o=e.npm)||void 0===o?void 0:o.getDependencyType())!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP}))}getDependenciesByFilter(e,n,o,t){this._allDependency.clear();const s=[],d=new Map,l=this.buildSelfDependency(e,n),r={moduleName:this._moduleName,modulePkgJsonPath:n,children:[],npm:l,module:l};this.collectHarDependency(r),this.collectFromTree(r,s,d,o);return{npmDependencies:s,moduleDependencyMap:d,modulePkgNode:r,projectPkgNode:this.collectProjectHarDependencyForHap(d,s,t)}}collectAllHspDependencies(){const{moduleDependencyMap:e}=this.collectAllDependencies();return[...e.entries()].filter((([,e])=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP))}collectProjectHarDependencyForHap(e,n,o){if(!this._projectModel)return;const t=this._isOhpmDependency?this._projectModel.getOhPackageJson5Path():this._projectModel.getPackageJsonPath(),s=this.buildSelfDependency(this._projectModel,t),d={moduleName:this._projectModel.getName(),modulePkgJsonPath:t,children:[],npm:s,module:s};this.collectHarDependency(d);return this.collectFromTree(d,n,e,((e,n,t)=>!(e.module&&!this._model.isHapModule())&&(!o||o(e,n,t)))),d}collectHarDependency(e){const n=[e];for(;n.length>0;){let e=n.shift();if(void 0===e||!fs_1.default.existsSync(e.modulePkgJsonPath))continue;const o=getJson5Obj(oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(e.modulePkgJsonPath));if(null===o)continue;this.resolveDeps(o,e,n,dependency_interface_js_1.DependencyEnum.DEPENDENCIES,null==o?void 0:o.dependencies),this.resolveDeps(o,e,n,dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES,null==o?void 0:o.dynamicDependencies),this.resolveDeps(o,e,n,dependency_interface_js_1.DependencyEnum.DEV_DEPENDENCIES,null==o?void 0:o.devDependencies);const t=`${e.npm.getDependencyName()}@${e.modulePkgJsonPath}`;let s=hvigor_1.hvigorCore.getCache("DEP_NODE");!s.has(t)&&s.set(t,e)}}resolveDeps(e,n,o,t,s){for(const e in null!=s?s:{}){this._allDependency.add(`${n.modulePkgJsonPath}@${e}`);const d=s[e];if(Object.prototype.hasOwnProperty.call(s,e)){let s=this.collectDependency(e,d,n.moduleName,n,o,t);s&&n.children.push(s)}}}collectFromTree(e,n,o,t){const s=[...e.children],d=new Set,l=new Map(n.map((e=>[e.getDependencyName(),e.getDependencyRootPath()])));for(;s.length>0;){const e=s.shift();if(d.has(e.modulePkgJsonPath))continue;if(t&&!t(e,!0,!1))continue;const r=l.get(e.npm.getDependencyName());if(r&&r===e.npm.getDependencyRootPath()||(n.push(e.npm),l.set(e.npm.getDependencyName(),e.npm.getDependencyRootPath())),e.module&&e.module.isLocal()){const n=o.get(e.module.getModuleName());n?(0,dependency_interface_js_1.compareDependencyEnum)(e.module.getDependencyEnum(),n.getDependencyEnum())>0&&o.set(e.module.getModuleName(),e.module):o.set(e.module.getModuleName(),e.module)}t&&!t(e,!1,!0)||(s.push(...e.children),d.add(e.modulePkgJsonPath))}}collectDependency(e,n,o,t,s,d){var l,r,a,c,i;const _=this._isOhpmDependency?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON,p=(this._isOhpmDependency?new ohpm_package_resolver_js_1.OhpmPackageResolver:new npm_package_resolver_js_1.NpmPackageResolver).resolvePackagePath(e,path_1.default.dirname(t.modulePkgJsonPath),log);if(void 0===p||!fs_1.default.existsSync(p))return void(fs_1.default.existsSync(path_1.default.resolve(this._model.getProjectDir(),common_const_js_1.CommonConst.OH_MODULES))&&log.warn(`The current module '${this._moduleName}' has dependency which is not installed at its ${_}.`));const u=hvigor_1.hvigorCore.getCache("DEP_NODE").get(`${e}@${p}`);if(u){const e={npm:(new dependency_builder_js_1.DependencyBuilder).setDependencyName(u.npm.getDependencyName()).setDependedVersion(n).setDependencyRootPath(u.npm.getDependencyRootPath()).setPkgJsonPath(u.npm.getPackageFilePath()).setPkgJsonObj(u.npm.getPackageJsonObj()).setDependencyType(u.npm.getDependencyType()).setDependencyEnum(d).setModuleJsonObj(u.npm.getModuleJsonObj()).setIsLocal(u.npm.isLocal()).setLastDependencyName(o).buildDefaultNpmDependency(),parent:t,children:[...u.children],moduleName:u.moduleName,modulePkgJsonPath:u.modulePkgJsonPath};return u.module&&(e.module=(new dependency_builder_js_1.DependencyBuilder).setModule(u.module.getModule()).setDependencyName(u.module.getDependencyName()).setDependedVersion(n).setDependencyRootPath(u.module.getDependencyRootPath()).setPkgJsonPath(u.module.getPackageJsonPath()).setPkgJsonObj(u.module.getPackageJsonObj()).setDependencyType(u.module.getDependencyType()).setDependencyEnum(d).setIsLocal(!0).setModuleJsonObj(u.module.getModuleJsonObj()).setLastDependencyName(o).buildDefaultModuleDependency()),e}const m=getJson5Obj(p),h=null!==(r=null!==(l=this.getHarmonyDependencyType(p,m,t.modulePkgJsonPath,e))&&void 0!==l?l:this.getSODependencyType(m.name))&&void 0!==r?r:this._allDependency.has(`${p}@${e}`)?void 0:dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER;switch(h){case dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAP:log.warn(`HAP dependency (module "${e}") detected in path "${t.modulePkgJsonPath}".\n          Try the following:\n          1. Remove the dependency on module "${e}".\n          2. Change module "${e}" to a HAR or HSP.`);case void 0:return}const y=path_1.default.dirname(p);this.checkHarStatusIsCompatibleForHap(y,m),this._allDependency.add(`${p}@${e}`);const g=null===(a=hvigor_1.hvigorCore.getProject())||void 0===a?void 0:a.getAllSubModules();if(!g)return;const D=null!==(c=this.getModuleJsonObj(new base_package_resolver_js_1.BasePackageResolver("src/main/module.json5",common_const_js_1.CommonConst.OH_MODULES).resolvePackagePath(e,path_1.default.dirname(t.modulePkgJsonPath),log)))&&void 0!==c?c:this.getModuleJsonObj(new base_package_resolver_js_1.BasePackageResolver("src/main/module.json",common_const_js_1.CommonConst.OH_MODULES).resolvePackagePath(e,path_1.default.dirname(t.modulePkgJsonPath),log));let P,j=p,f=!1;const E=g.find((e=>e.getNodeDir()===y));if(E){j=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.join(E.getNodeDir(),_));const s=(new dependency_builder_js_1.DependencyBuilder).setModule(E).setDependencyName(e).setDependedVersion(n).setLastDependencyName(t.moduleName).setDependencyRootPath(E.getNodeDir()).setPkgJsonPath(j).setPkgJsonObj(m).setDependencyType(h).setDependencyEnum(d).setIsLocal(!0).setModuleJsonObj(D).buildDefaultModuleDependency();s.isModuleDependency=!!o,f=!0,P=s}const v=oh_package_loader_js_1.ohPackageLoader.getOriginPathFromUpdatePath([j])[0],N=(new dependency_builder_js_1.DependencyBuilder).setDependencyName(e).setDependedVersion(n).setDependencyRootPath(v).setPkgJsonPath(j).setPkgJsonObj(m).setDependencyType(h).setDependencyEnum(d).setModuleJsonObj(D).setIsLocal(f).buildDefaultNpmDependency();N.isModuleDependency=!!o;const M={moduleName:null!==(i=null==P?void 0:P.getModuleName())&&void 0!==i?i:e,modulePkgJsonPath:p,parent:t,children:[],npm:N,module:P};return h!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR&&h!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER&&h!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP||s.push(M),M}getModuleJsonObj(e){if(void 0!==e&&fs_1.default.existsSync(e))return getJson5Obj(e)}getDependencyTypeByProfile(e){const n=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.MODULE_JSON5),o=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.MODULE_JSON),t=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.CONFIG_JSON);return this.checkHarOrHspStatus(n,!1)||this.checkHarOrHspStatus(o,!1)||this.checkHarOrHspStatus(t,!0)}checkHarOrHspStatus(e,n){var o,t,s,d,l,r,a,c,i,_;if(!fs_1.default.existsSync(e))return;const p=getJson5Obj(e),u=(null===(o=p.module)||void 0===o?void 0:o.type)===module_type_enum_js_1.ModuleType.Shared,m=(null===(t=p.module)||void 0===t?void 0:t.type)===module_type_enum_js_1.ModuleType.Har||(null===(d=null===(s=p.module)||void 0===s?void 0:s.distro)||void 0===d?void 0:d.moduleType)===module_type_enum_js_1.ModuleType.Har,h=(null===(l=p.module)||void 0===l?void 0:l.type)===module_type_enum_js_1.ModuleType.Entry||(null===(r=p.module)||void 0===r?void 0:r.type)===module_type_enum_js_1.ModuleType.Feature||(null===(c=null===(a=p.module)||void 0===a?void 0:a.distro)||void 0===c?void 0:c.moduleType)===module_type_enum_js_1.ModuleType.Entry||(null===(_=null===(i=p.module)||void 0===i?void 0:i.distro)||void 0===_?void 0:_.moduleType)===module_type_enum_js_1.ModuleType.Feature,y=this._isFaMode?"FA model":"Stage model",g=this._isFaMode?"Stage model":"FA model";return(m||u)&&this._isFaMode!==n&&log._buildError(`${y} module ${this._moduleName} does not allow Harmony library packages or modules in ${g}. Build tasks will not be executed, and resources will not be packed.`)._detail(solution)._file(e)._printErrorAndExit(this._moduleName),u?dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP:m?dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR:h?dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAP:void 0}getHarmonyDependencyType(e,n,o,t){if(!e||null===n)return;const s=path_1.default.dirname(e),d=this.isHarForDiffPackManagement(s,n),l=this.getDependencyTypeByProfile(s);return d&&this._allDependency.has(`${e}@${t}`)&&e===o&&l===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP&&log._buildError("Shared Library cannot depend on shared module self.")._detail("Remove the dependency on the shared module.")._file(s)._printErrorAndExit(this._moduleName),d&&n.name&&!this._allDependency.has(`${e}@${t}`)?l:void 0}isHarForDiffPackManagement(e,n){return this._isOhpmDependency?fs_1.default.existsSync(e):fs_1.default.existsSync(e)&&void 0!==n.ohos}checkHarStatusIsCompatibleForHap(e,n){var o;if(this._model instanceof core_project_model_impl_js_1.CoreProjectModelImpl)return;const t=this._model;if(t.isHarModule())return;const s=this._isOhpmDependency?n.artifactType:null===(o=n.ohos)||void 0===o?void 0:o.artifactType;void 0!==s&&s!==har_extend_info_js_1.ArtifactType.ORIGINAL&&t instanceof legacy_module_model_impl_js_1.LegacyModuleModelImpl&&log._buildError(`Fa module ${this._moduleName} does not allow OpenHarmony npm packages,\n      which artifactType is not original.`)._solution(solution)._file(e)._printErrorAndExit(this._moduleName)}static isLocalDependencyForSo(e){return!e.includes("oh_modules")}static isLocalDependency(e,n){return n.has(e.getDependencyRootPath())}static getModuleNameFromOhPkgJson(e){var n;const o=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(e,common_const_js_1.CommonConst.OH_PACKAGE_JSON5));if(!fs_1.default.existsSync(o))return"";const t=getJson5Obj(o);return null!==(n=null==t?void 0:t.name)&&void 0!==n?n:""}static getRemoteDependencyRouterMapObjList(e){var n,o;const t=path_1.default.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),s=this.getModuleObjByRemoteDependency(e),d=null!==(n=(0,common_util_js_1.parsingProfileName)(null==s?void 0:s.module.routerMap))&&void 0!==n?n:void 0;if(!d)return;const l=getJson5Obj(path_1.default.resolve(t,build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR,`${d}.json`));return l.routerMap.forEach((n=>{Object.assign(n,{moduleNodeDir:e.getDependencyRootPath()})})),null!==(o=l.routerMap)&&void 0!==o?o:void 0}static getLocalDependencyRouterMapObjList(e,n){var o;if(!e)return;const t=this.getModuleModelByDependency(e,n);if(!t)return;const s=this.getDependencyModuleRouterMapJsonPath(t);if(!s||!fs_1.default.existsSync(s))return;const d=getJson5Obj(s);return d.routerMap.forEach((e=>{Object.assign(e,{moduleNodeDir:t.getModule().getNodeDir()})})),null!==(o=d.routerMap)&&void 0!==o?o:void 0}static getDependencyModuleRouterMapJsonPath(e){if(!e)return;const n=this.getRouterMapJsonFileName(e);return n?path_1.default.resolve(e.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR,`${n}.json`):void 0}static getRouterMapJsonFileName(e){if(!e)return;const n=path_1.default.resolve(e.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,common_const_js_1.CommonConst.MODULE_JSON5),o=res_model_loader_js_1.resModelLoader.getModuleJson(n).module.routerMap;return(0,common_util_js_1.parsingProfileName)(o)}static getModuleModelByDependency(e,n){if(!e.isLocal())return;const o=n.getAllModules().find((o=>(n.isOhpmProject()?o.getOhPackageJson5Path():o.getPackageJsonPath())===e.getPackageFilePath()));return null!=o?o:void 0}static getModuleObjByRemoteDependency(e){const n=path_1.default.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),o=path_1.default.resolve(n,common_const_js_1.CommonConst.MODULE_JSON),t=path_1.default.resolve(n,common_const_js_1.CommonConst.MODULE_JSON5);return getJson5Obj(fs_1.default.existsSync(o)?o:fs_1.default.existsSync(t)?t:"")}getSODependencyType(e){return(null==e?void 0:e.includes(".so"))?dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_SO:void 0}}function getEntryMainFilePath(e,n){const o=path_1.default.resolve(e,(0,hvigor_arkts_compose_1.findNodeEntryFiles)(n)[0]);if(fs_1.default.existsSync(o))return o;{const o=getEntryPath(n.main,n.types),t=path_1.default.resolve(e,o);return fs_1.default.existsSync(t)?t:""}}function getEntryPath(e,n){return e&&""!==e?e:n&&""!==n?n:build_directory_const_js_1.BuildArtifactConst.INDEX_ETS}exports.DependencyManager=DependencyManager,exports.getEntryMainFilePath=getEntryMainFilePath,exports.getEntryPath=getEntryPath;