"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,a)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PrepareSharedHarRes=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),fs=__importStar(require("fs-extra")),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),cmake_util_js_1=require("../../utils/cmake-util.js"),dependency_util_js_1=require("../../utils/dependency-util.js"),file_util_js_1=require("../../utils/file-util.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),npm_utils_js_1=require("../../utils/npm-utils.js"),task_names_js_1=require("../common/task-names.js"),har_extend_info_js_1=require("../har/har-extend-info.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");var Task=task_names_js_1.TaskNames.Task;const parameter_utils_js_1=require("../../utils/parameter-utils.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("PrepareSharedHarRes"),DECLARE_FILE_OUTPUT=build_directory_const_js_1.BuildDirConst.DECLARE_FILE_OUTPUT;class PrepareSharedHarRes extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var t;super(e,Task.PREPARE_SHARED_HAR_RES),this.INTERFACE_HAR="InterfaceHar",this.ignoreFileList=[build_directory_const_js_1.BuildDirConst.LIBS,build_directory_const_js_1.BuildDirConst.BUILD_ROOT,common_const_js_1.CommonNodeConst.NODE_MODULES,common_const_js_1.CommonConst.OH_MODULES,".cxx",".previewer",".hvigor",".gitignore",".ohpmignore"],this.allInvalidPrefix=[];const s=path_1.default.relative(this.moduleModel.getBelongProjectPath(),this.moduleModel.getProjectDir()),i=this.targetService.getBuildOption();this.inputPackageJson5Path=e.getTargetData().getModuleModel().getOhPackageJson5Path(),this.inputModuleJsonPath=this.pathInfo.getIntermediatesProcessProfile(),this.inputResourceStr=this.pathInfo.getResourceStr(),this.inputDeclareFilesPath=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),DECLARE_FILE_OUTPUT,s);const a=null===(t=i.nativeLib)||void 0===t?void 0:t.headerPath;"string"==typeof a?this.headerPath=[a]:Array.isArray(a)?this.headerPath=a:this.headerPath=[],this.libsPath=this.pathInfo.getIntermediatesStrippedLibsDir(),this.taskTmpDir=this.getTaskTempDir(this.targetData,"shared_har",!1),this.outputPackageJsonPath=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.taskTmpDir,common_const_js_1.CommonConst.OH_PACKAGE_JSON5)),this.outputModuleJsonPath=path_1.default.resolve(this.taskTmpDir,"src","main",common_const_js_1.CommonConst.MODULE_JSON),this.outputResourceStr=path_1.default.resolve(this.taskTmpDir,"src","main","resource"),this.outputDeclareFilesPath=this.taskTmpDir,this._moduleDir=this.moduleModel.getProjectDir(),this.initAllInvalidPrefix(),this._harExtendInfo=new har_extend_info_js_1.HarExtendInfo(this.moduleModel,e.getBuildOption());const r=cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,i.externalNativeOptions);this.hasNativeOption=r,this.cmakeListDir=r?cmake_util_js_1.CmakeUtil.getCmakeListDir(this.moduleModel,this.targetName,i.externalNativeOptions):void 0}declareInputs(){var e;const t=new Map;return this.packageJsonObj&&t.set("modulePackageJsonObj",JSON.stringify(this.packageJsonObj)),t.set("integratedHsp",!!(null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.integratedHsp)),t.set(common_const_js_1.CommonConst.KEEP_DEPENDENCY,!!(0,parameter_utils_js_1.getPropertyKeepDependency)()),t}declareInputFiles(){const e=this.allInvalidPrefix.join("|").replace(/\\/g,"\\\\"),t=RegExp(`^(?!${e}).*`),s=super.declareInputFiles().addEntry(this.inputPackageJson5Path).addEntry(this.inputModuleJsonPath).addEntry(this._moduleDir,{isDirectory:!0,test:t}).addEntry(this.libsPath);fs_extra_1.default.existsSync(this.inputDeclareFilesPath)&&s.addEntry(this.inputDeclareFilesPath,{isDirectory:!0}),fs_extra_1.default.existsSync(this.inputResourceStr)&&s.addEntry(this.inputResourceStr);for(const e of this.headerPath){const t=path_1.default.isAbsolute(e)?e:path_1.default.resolve(this._moduleDir,e);fs.pathExistsSync(t)&&s.addEntry(t)}return s}declareOutputFiles(){return super.declareOutputFiles().addEntry(this.taskTmpDir,{isDirectory:!0})}initTaskDepends(){this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET?this.declareDepends("OhosTestCompileArkTS"):this.declareDepends("CompileArkTS"),this.declareDepends(task_names_js_1.TaskNames.Task.DO_NATIVE_STRIP.name)}async doTaskAction(){this.preCheckBeforePack(),this.copyLocalDepsFileToTempDir(),file_util_js_1.FileUtil.copySpecialFileToTempDir(this.moduleModel.getProjectDir(),this.taskTmpDir),fs_extra_1.default.existsSync(this.inputDeclareFilesPath)&&fs_extra_1.default.copySync(this.inputDeclareFilesPath,this.outputDeclareFilesPath),this.generatePackageJson(),this.generateModuleJson(),this.copyResourcesTxt(),this.initRes(),await this.syncNative()}copyResourcesTxt(){const e=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT);fs_extra_1.default.existsSync(e)&&fs_extra_1.default.copySync(e,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT))}async syncNative(){for(const e of this.headerPath){const t=new Map,s=path_1.default.isAbsolute(e)?e:path_1.default.resolve(this._moduleDir,e);cmake_util_js_1.CmakeUtil.checkNativeHeader(s,this.moduleModel,t),fs_extra_1.default.existsSync(s)&&await fs_extra_1.default.copy(s,path_1.default.resolve(this.taskTmpDir,"include"),{recursive:!0})}fs_extra_1.default.existsSync(this.libsPath)&&fs_extra_1.default.readdirSync(this.libsPath).length>0&&await fs_extra_1.default.copy(this.libsPath,path_1.default.resolve(this.taskTmpDir,"libs"),{recursive:!0})}generatePackageJson(){var e,t,s,i;let a=this.packageJsonObj;a.types=(0,npm_utils_js_1.getTypesFieldFromMainField)(a.main),a.main=void 0,a.packageType&&a.packageType!==this.INTERFACE_HAR&&_log.warn("share library packageType in oh-package.json should use InterfaceHar"),a.packageType||(a.packageType=this.INTERFACE_HAR);const r=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl,o=path_1.default.relative(this.pathInfo.getModuleBuildPath(),this.pathInfo.getGenerateBuildProfileDir()),n=[...(null===(s=this.targetData.getTargetOpt().source)||void 0===s?void 0:s.sourceRoots)||[],`./${build_directory_const_js_1.BuildDirConst.SRC}/${build_directory_const_js_1.BuildDirConst.MAIN}`,`./${this.pathInfo.getBuildRoot()}/${o.replace(/\\/g,"/")}/${this.targetName}`],l={useNormalizedOHMUrl:r,integratedHsp:null===(i=this.targetService.getBuildOption().arkOptions)||void 0===i?void 0:i.integratedHsp,sourceRoots:n,debug:this.targetService.isDebug()};a.metadata?Object.assign(a.metadata,l):Object.assign(a,{metadata:l}),(0,dependency_util_js_1.minimizeHspDependencies)(a,this.service,this.packageManagerPath);const d=cmake_util_js_1.CmakeUtil.getHarExtraParams(this);a=file_util_js_1.FileUtil.mergeExtraParamsToOhPack(a,d,this.targetName),fs_extra_1.default.outputJsonSync(this.outputPackageJsonPath,a,{encoding:"utf8",spaces:"  "})}copyLocalDepsFileToTempDir(){(0,npm_utils_js_1.collectLocalFileDependency)(this.inputPackageJson5Path,this.packageJsonObj).forEach((e=>{const t=path_1.default.resolve(this._moduleDir,e);fs_extra_1.default.pathExistsSync(t)&&fs.copySync(t,path_1.default.resolve(this.taskTmpDir,path_1.default.relative(this._moduleDir,t)))}))}generateModuleJson(){var e;const t=fs_extra_1.default.readJsonSync(this.inputModuleJsonPath,{encoding:"utf8"});let s=t.app.bundleName;const i=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.integratedHsp;this.moduleModel.isHspModule()&&i&&(s=""),t.app={bundleName:s,bundleType:t.app.bundleType,debug:t.app.debug,versionCode:t.app.versionCode,versionName:t.app.versionName,minCompatibleVersionCode:t.app.minCompatibleVersionCode,minAPIVersion:t.app.minAPIVersion,targetAPIVersion:t.app.targetAPIVersion,apiReleaseType:t.app.apiReleaseType},t.module={name:t.module.name,type:t.module.type,deliveryWithInstall:t.module.deliveryWithInstall,deviceTypes:t.module.deviceTypes,requestPermissions:t.module.requestPermissions,dependencies:t.module.dependencies,libIsolation:t.module.libIsolation},fs_extra_1.default.outputJsonSync(this.outputModuleJsonPath,t,{encoding:"utf8"})}preCheckBeforePack(){const e=this.moduleModel.getOhPackageJson5Path(),t=this.packageJsonObj;return(0,npm_utils_js_1.checkHasLocalFileDependency)(e,t)&&_log._buildError(`Local dependencies detected during har packing of module ${this.moduleName}. Declaring local dependencies in har module might cause failing during install har package.`)._detail("Check oh-package.json5 file of current shared library module and replace the local dependencies.")._file(e)._printWarn(this.moduleName),fs_extra_1.default.emptyDirSync(this.taskTmpDir),!0}initAllInvalidPrefix(){for(const e of this.ignoreFileList)this.allInvalidPrefix.push(path_1.default.resolve(this._moduleDir,e))}initRes(){fs_extra_1.default.existsSync(this.pathInfo.getResourceStr())&&fs_extra_1.default.copySync(this.inputResourceStr,this.outputResourceStr)}}exports.PrepareSharedHarRes=PrepareSharedHarRes;