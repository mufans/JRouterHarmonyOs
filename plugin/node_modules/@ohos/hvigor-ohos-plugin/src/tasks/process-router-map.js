"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessRouterMap=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),file_util_js_1=require("../utils/file-util.js"),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../utils/ohmurl-utils.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),array_util_js_1=require("../utils/array-util.js"),log_adaptor_js_1=require("../utils/log/log-adaptor.js");class ProcessRouterMap extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var t,o,r;super(e,task_names_js_1.TaskNames.Task.PROCESS_ROUTER_MAP),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProcessRouterMap.name),this.compileEntry=[],this.routerMapFileName=this.targetService.getRouterMapJsonFileName(this.moduleModel),this.intermediatesRouterMapObjs=[],this.intermediatesTempRouterMapFilePath=this.pathInfo.getIntermediatesRouterMap(null!==(t=this.routerMapFileName)&&void 0!==t?t:build_directory_const_js_1.BuildArtifactConst.TEMP_ROUTER_MAP_FILE_NAME),this.intermediatesToLoaderRouterMap=this.pathInfo.getIntermediatesRouterMap(build_directory_const_js_1.BuildArtifactConst.LOADER_ROUTER_MAP_FILE_NAME),this.useNormalizedOHMUrl=!!(null===(r=null===(o=this.targetService.getBuildOption())||void 0===o?void 0:o.strictMode)||void 0===r?void 0:r.useNormalizedOHMUrl)}declareInputFiles(){const e=super.declareInputFiles(),t=this.projectModel.isOhpmProject();e.addEntry(t?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()).addEntry(t?this.projectModel.getOhPackageJson5Path():this.projectModel.getPackageJsonPath()).addEntry(this.moduleModel.getJsonPathByTargetName(this.targetName));const o=this.targetService.getRouterMapJsonPath(this.moduleModel);return o&&fs_extra_1.default.existsSync(o)&&e.addEntry(o),fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),e}declareOutputFiles(){return super.declareOutputFiles().addEntry(this.intermediatesTempRouterMapFilePath).addEntry(this.intermediatesToLoaderRouterMap)}declareInputs(){const e=super.declareInputs();return e.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,this.useNormalizedOHMUrl),e.set("obfuscated",this.targetService.isOpenSource()),e.set("byteCodeHar",this.targetService.isByteCodeHar()),this.service.getHarDependencies().forEach((t=>{if(t.isLocal()){const o=dependency_manager_js_1.DependencyManager.getLocalDependencyRouterMapObjList(t,this.projectModel);o&&e.set("localDependencyRouterMapObjList",JSON.stringify(o))}else{const o=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(t);o&&e.set("remoteDependencyRouterMapObjList",JSON.stringify(o))}})),e}doTaskAction(){const e=this.targetService.getTargetRouterMapObjList(this.moduleModel);this.service.getModuleModel().getModuleType()===module_type_enum_js_1.ModuleType.Har?this.processHarRouterMap(e):this.processHapOrHspRouterMap(e)}processHarRouterMap(e){if(!e)return;this.checkModuleRouterMapObj(e,this.moduleModel,!1),this.checkRouterMapObjName(e);const t=this.hasUseTsHarField()?".ts":".js";e.forEach((e=>{const o={name:e.name,pageSourceFile:path_1.default.resolve(this.module.getNodeDir(),e.pageSourceFile),buildFunction:e.buildFunction};if(this.intermediatesRouterMapObjs.push(o),this.compileEntry.push(o.pageSourceFile),!this.targetService.isOpenSource()||this.targetService.isByteCodeHar()){const o=e.pageSourceFile,r=file_util_js_1.FileUtil.getFileSuffix(o);common_const_js_1.ValidateRegExp.DYNAMIC_IMPORT_FILE_SUFFIX_REG_EXP.test(r)&&Object.assign(e,{pageSourceFile:`${o.substring(0,o.lastIndexOf("."))}${t}`,originalSuffix:`.${r}`})}})),this.generateTempRouterMap(e,this.intermediatesRouterMapObjs)}processHapOrHspRouterMap(e){const t=[];this.processModuleSelfRouterMap(t,e),this.processModuleDependencyRouterMap(t),this.checkRouterMapObjName(t),this.generateTempRouterMap(t,this.intermediatesRouterMapObjs)}processModuleSelfRouterMap(e,t){t&&(this.checkModuleRouterMapObj(t,this.moduleModel,!1),t.forEach((e=>{const t=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),e.pageSourceFile);this.compileEntry.push(t);let o="";if(this.useNormalizedOHMUrl){const t=this.pathInfo.getIntermediatesPkgContextInfoPath(),r=(0,json_util_js_1.getJson5Obj)(t)[this.packageJsonObj.name];o=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(r,e.pageSourceFile)}else o=this.generateModuleOhmurl(this.moduleName,e.pageSourceFile);Object.assign(e,{ohmurl:o,bundleName:this.getBundleName(),moduleName:this.moduleName});const r={ohmurl:o,name:e.name,pageSourceFile:t,buildFunction:e.buildFunction};this.intermediatesRouterMapObjs.push(r)})),e.push(...t))}processModuleDependencyRouterMap(e){const t=new Map;this.service.getHarDependencies().forEach((o=>{o.isLocal()?this.processLocalDependencyRouterMap(o,e,t):this.processRemoteDependencyRouterMap(o,e)}))}processLocalDependencyRouterMap(e,t,o){const r=this.getModuleModelByDependency(e),s=dependency_manager_js_1.DependencyManager.getLocalDependencyRouterMapObjList(e,this.projectModel);r&&s&&!o.has(r)&&(o.set(r,s),this.checkModuleRouterMapObj(s,r,!0),s.forEach((t=>{const o=path_1.default.resolve(e.getDependencyRootPath(),t.pageSourceFile),s=r.getModuleType();this.pushCompileEntry(s,o);let a="";this.useNormalizedOHMUrl?a=this.getOhmUrlWithNormalize(e,t.pageSourceFile):(s===module_type_enum_js_1.ModuleType.Shared&&(a=this.generateModuleOhmurl(r.getName(),t.pageSourceFile)),s===module_type_enum_js_1.ModuleType.Har&&(a=this.generateHarOhmurl(this.moduleName,r.getName(),t.pageSourceFile,!0))),Object.assign(t,{ohmurl:a,bundleName:this.getBundleName(),moduleName:this.moduleName});const i={ohmurl:a,name:t.name,pageSourceFile:o,buildFunction:t.buildFunction};this.intermediatesRouterMapObjs.push(i)})),this.checkDependencyRouterMap(e,s),t.push(...s))}processRemoteDependencyRouterMap(e,t){const o=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(e);if(!o)return;const r=dependency_manager_js_1.DependencyManager.getModuleObjByRemoteDependency(e),s=r.module.type;o.forEach((t=>{const o=t.pageSourceFile,a=path_1.default.resolve(e.getDependencyRootPath(),o);e.isByteCodeHarDependency()||this.pushCompileEntry(s,a);const i=r.module.name;let n;this.useNormalizedOHMUrl?n=this.getOhmUrlWithNormalize(e,t.pageSourceFile):(s===module_type_enum_js_1.ModuleType.Shared&&(n=this.generateModuleOhmurl(i,t.pageSourceFile)),s===module_type_enum_js_1.ModuleType.Har&&(n=this.generateHarOhmurl(this.moduleName,i,a,!1,e.getDependencyName()))),Object.assign(t,{ohmurl:n,bundleName:this.getBundleName(),moduleName:this.moduleName});const u={ohmurl:n,name:t.name,pageSourceFile:a,buildFunction:t.buildFunction};this.intermediatesRouterMapObjs.push(u)})),this.checkDependencyRouterMap(e,o),t.push(...o)}checkModuleRouterMapObj(e,t,o){if(!e)return;const r=t.getName();e.forEach((e=>{const s=o?dependency_manager_js_1.DependencyManager.getDependencyModuleRouterMapJsonPath(t):this.targetService.getRouterMapJsonPath(t),a=this.getModulePageSourceFile(t,e);""!==e.pageSourceFile&&""!==a&&a&&fs_extra_1.default.existsSync(a)||this._log._buildError(`Unable to find the page source file '${null!=a?a:""}' in module '${r}' routerMap configuration.`)._detail(`Check the routerMap configuration of the module '${r}'.`)._file(null!=s?s:"")._printErrorAndExit(),common_const_js_1.ValidateRegExp.PAGE_SOURCE_FILE_REG_EXP.test(e.pageSourceFile)||this._log._buildError(`Invalid pageSourceFile format in the '${r}' routerMap configuration.`)._detail("PageSourceFile field in routerMap configuration must be defined as relative path starting with 'src/main' format.")._file(null!=s?s:"")._printErrorAndExit()}))}getModulePageSourceFile(e,t){const o=t.pageSourceFile;if(""!==o)return path_1.default.resolve(e.getModule().getNodeDir(),o)}checkDependencyRouterMap(e,t){t&&t.forEach((t=>{const o=this.getModuleModelByDependency(e);if(!o)return;const r=null==o?void 0:o.getName(),s=dependency_manager_js_1.DependencyManager.getDependencyModuleRouterMapJsonPath(o),a=t.pageSourceFile,i=path_1.default.resolve(e.getDependencyRootPath(),a);""!==a&&""!==i&&i&&fs_extra_1.default.existsSync(i)||this._log._buildError(`Unable to find the page source file '${""===a?"":i}' in module '${r}' routerMap configuration.`)._detail(`Check the routerMap configuration of the module '${r}'.`)._file(null!=s?s:"")._printErrorAndExit()}))}getModuleModelByDependency(e){const t=this.projectModel.getAllModules().find((t=>(this.projectModel.isOhpmProject()?t.getOhPackageJson5Path():t.getPackageJsonPath())===e.getPackageFilePath()));return null!=t?t:void 0}checkRouterMapObjName(e){if(!e||e.length<=1)return;const t=new Map;e.forEach((e=>{const o=path_1.default.parse(e.moduleNodeDir).name;if(t.has(o)){const r=t.get(o);if(!r)return;r.push(e.name),t.set(o,r)}else t.set(o,[e.name])}));const o=new Map;if(t.forEach(((e,r)=>{const s=(0,array_util_js_1.findDuplicateElement)(e);t.forEach(((t,o)=>{if(o===r)return;const a=(0,array_util_js_1.getIntersection)(t,e);0!==a.length&&s.push(...a)})),0!==s.length&&o.set(r,Array.from(new Set(s)))})),0!==o.size){const e=new log_adaptor_js_1.OhosLogAdaptor("HE10004",hvigor_1.globalData.buildId).formatMessage().formatSolutions(0,JSON.stringify(Object.fromEntries(o.entries()))).getLogMessage();this._log.printErrorExit(e)}}getBundleName(){var e;return null!==(e=this.targetData.getProduct().bundleName)&&void 0!==e?e:this.projectModel.getDefaultBundleName()}generateModuleOhmurl(e,t){const o=t.substring(0,t.indexOf(".")),r=o.includes("src/main/ets/")?o.replace("src/main/",""):o;return`@bundle:${this.getBundleName()}/${e}/${r}`}generateHarOhmurl(e,t,o,r,s){if(r){const r=o.substring(0,o.indexOf(".")),s=r.includes("src/main/ets/")?r.replace("src/main/",""):r;return`@bundle:${this.getBundleName()}/${e}@${t}/${s}`}const a=path_1.default.parse(o).name,i=`${o.substring(0,o.lastIndexOf(path_1.default.sep)+1)}${a}`,n=i.substring(i.indexOf(common_const_js_1.CommonConst.OH_MODULES)).replace(common_const_js_1.CommonConst.OH_MODULES,common_const_js_1.CommonConst.PKG_MODULES),u=n.indexOf(path_1.default.sep+(null==s?void 0:s.replace("/",path_1.default.sep))+path_1.default.sep),l=n.substring(0,u),d=l.replace(path_1.default.basename(l),common_const_js_1.CommonConst.PKG_MODULES)+n.substring(u),c=new RegExp("\\"+path_1.default.sep,"g");return`@package:${d.replace(c,"/")}`}pushCompileEntry(e,t){e!==module_type_enum_js_1.ModuleType.Shared&&this.compileEntry.push(t)}initTaskDepends(){}getOhmUrlWithNormalize(e,t){const o=e.getPackageName(),r=this.pathInfo.getIntermediatesPkgContextInfoPath(),s=(0,json_util_js_1.getJson5Obj)(r);s||this._log._buildError(`The pkgContextInfoPath ${r} is not available.`)._printErrorAndExit();const a=s[o];return a||this._log._buildError(`The pkgName ${o} does not exist in ${r}.`)._printErrorAndExit(),(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(a,t)}generateTempRouterMap(e,t){fs_extra_1.default.ensureFileSync(this.intermediatesTempRouterMapFilePath),fs_extra_1.default.writeFileSync(this.intermediatesTempRouterMapFilePath,JSON.stringify({routerMap:e})),fs_extra_1.default.ensureFileSync(this.intermediatesToLoaderRouterMap),fs_extra_1.default.writeFileSync(this.intermediatesToLoaderRouterMap,JSON.stringify({routerMap:t}))}}exports.ProcessRouterMap=ProcessRouterMap;