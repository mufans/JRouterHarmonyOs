"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSoDefaultContextInfo=exports.GeneratePkgContextInfo=exports.soLibsPattern=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),common_const_js_1=require("../const/common-const.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),cmake_util_js_1=require("../utils/cmake-util.js"),copy_resources_util_js_1=require("../utils/copy-resources-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),ohos_test_util_js_1=require("../utils/ohos-test-util.js"),process_libs_common_properties_js_1=require("./common-properties/process-libs-common-properties.js"),file_util_js_1=require("../utils/file-util.js"),inject_util_js_1=require("../utils/inject-util.js");exports.soLibsPattern=/^.*\.so(\.[0-9])*$/;class GeneratePkgContextInfo extends process_libs_common_properties_js_1.ProcessLibsCommonProperties{constructor(e){var t,o,n,s,i,r;super(e,task_names_js_1.TaskNames.Task.GENERATE_PKG_CONTEXT_INFO),this.pkgContextInfoMap=new Map,this._log=ohos_logger_js_1.OhosLogger.getLogger(GeneratePkgContextInfo.name);const a=this.projectModel.getAppRes().getAppResOpt(),l=(0,wdk_1.cloneDeep)(null===(t=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===t?void 0:t.appOpt),d=this.targetData.getProduct();this.currentBundleName=null!==(n=null!==(o=null==l?void 0:l.bundleName)&&void 0!==o?o:this.targetData.getProduct().bundleName)&&void 0!==n?n:this.projectModel.getDefaultBundleName(),this.currentBundleType=null!==(r=null!==(i=null!==(s=null==l?void 0:l.bundleType)&&void 0!==s?s:d.bundleType)&&void 0!==i?i:a.app.bundleType)&&void 0!==r?r:common_const_js_1.BundleType.APP,this.pkgInfoPath=this.pathInfo.getIntermediatesPkgContextInfoPath(),fs_extra_1.default.existsSync(path_1.default.dirname(this.pkgInfoPath))||fs_extra_1.default.mkdirSync(path_1.default.dirname(this.pkgInfoPath),{recursive:!0});const _=new dependency_manager_js_1.DependencyManager(this.projectModel.isFaMode(),this.moduleModel,this.projectModel);let{npmDependencies:c}=_.collectAllDependenciesForPkgInfo();if(inject_util_js_1.InjectUtil.isLocalTest()||inject_util_js_1.InjectUtil.isPreviewProcess()){const e=_.collectAllDependencies().npmDependencies.filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP));c=c.concat(e)}for(const e of c)this.pkgContextInfoMap.set(e.getPackageName(),this.getDependenciesPkgContextInfo(e));this.pkgContextInfoMap.set(this.packageJsonObj.name,this.getCurrentPkgContextInfo()),this.initLibsSoPkgContextInfo()}get useNormalizedOHMUrl(){var e,t;return!!(null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl)}declareInputs(){var e,t;const o=new Map;return o.set("pkgContextInfoMap",JSON.stringify(Object.fromEntries(this.pkgContextInfoMap))),o.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,!!(null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl)),o}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.pkgInfoPath,{isDirectory:!1})}beforeTask(){fs_extra_1.default.existsSync(this.pkgInfoPath)&&fs_extra_1.default.removeSync(this.pkgInfoPath)}taskShouldDo(){return this.useNormalizedOHMUrl}doTaskAction(){const e=JSON.stringify(Object.fromEntries(this.pkgContextInfoMap));fs_extra_1.default.writeFileSync(this.pkgInfoPath,e)}getCurrentPkgContextInfo(){return{packageName:this.packageJsonObj.name,bundleName:this.moduleModel.isHspModule()&&this.currentBundleType===common_const_js_1.BundleType.SHARED?this.currentBundleName:"",moduleName:"",version:this.moduleModel.isHarModule()?this.packageJsonObj.version:"",entryPath:this.getCurrentEntryPath(this.moduleModel.getProjectDir(),this.packageJsonObj),isSO:!1,dependencyAlias:""}}getCurrentEntryPath(e,t){if(this.moduleModel.isHapModule()||this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET){const t=this.moduleModel.getSourceRootByTargetName(this.targetName);if(this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(t)){const e=path_1.default.join((0,ohos_test_util_js_1.getOhosTestIntermediatesRelativePath)(),"src/ohosTest");return`${(0,copy_resources_util_js_1.toUnixPath)(e)}/`}return t?`${(0,copy_resources_util_js_1.toUnixPath)(path_1.default.relative(e,t))}/`:""}if(this.moduleModel.isHarModule()){const o=(0,dependency_manager_js_1.getEntryMainFilePath)(e,t);return o?(0,copy_resources_util_js_1.toUnixPath)(path_1.default.relative(e,path_1.default.resolve(e,o))):""}return""}getDependenciesPkgContextInfo(e){var t,o,n;const s=e.getDependencyType();return{packageName:e.getPackageName(),bundleName:this.getBundleName(e,s),moduleName:s===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP&&null!==(o=null===(t=e.getModuleJsonObj())||void 0===t?void 0:t.module.name)&&void 0!==o?o:"",version:this.getVersion(e,s),entryPath:(null!==(n=e.getDependencyMainFileRelativePath())&&void 0!==n?n:"").replace(/\.d\.e?ts$/,""),isSO:s===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_SO,dependencyAlias:this.getDepedencyAlias(e)}}getBundleName(e,t){var o,n,s,i;const r=e.getModuleJsonObj();return this.currentBundleType!==common_const_js_1.BundleType.SHARED?r&&this.isHspInCommonApp(r,t)&&(null===(o=r.app)||void 0===o?void 0:o.bundleName)!==this.currentBundleName?null===(n=r.app)||void 0===n?void 0:n.bundleName:"":t!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP||dependency_manager_js_1.DependencyManager.isLocalDependency(e,this.moduleModelNodePaths)?this.currentBundleName:this.isHspInCommonApp(r,t)&&r?null!==(i=null===(s=r.app)||void 0===s?void 0:s.bundleName)&&void 0!==i?i:"":(this._log._buildError(`The currentBundleType is shared, but the Package ${e.getPackageName()} bundleType is not shared.`)._printErrorAndExit(),"")}getVersion(e,t){if(t===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR||t===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER){const t={parameterFilePath:this.service.getProjectModel().getParameterFileAbsolutePath(),ohPackageFilePath:this.isOhpmProject?this.moduleModel.getOhPackageJson5Path():this.moduleModel.getPackageJsonPath()};return file_util_js_1.FileUtil.extracted(e.getDependencyVersion(),this.moduleModel.getParentProject().getParameterFileObj(),t)}return""}getDepedencyAlias(e){return e.getDependencyName()===e.getPackageName()?"":e.getDependencyName()}isHspInCommonApp(e,t){var o;return t===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP&&(null===(o=e.app)||void 0===o?void 0:o.bundleType)===common_const_js_1.BundleType.SHARED}initLibsSoPkgContextInfo(){this.getNativeLibrary(this.targetService);const e=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService);for(const[t,o]of e){const e=this.projectModel.getTarget(t,o);e&&(this.getNativeLibrary(e),this.getNativeLibraryByLibs(path_1.default.resolve(e.getModuleService().getModuleModel().getProjectDir(),build_directory_const_js_1.BuildDirConst.LIBS)))}this.getNativeLibraryByLibs(path_1.default.resolve(this.moduleModel.getProjectDir(),build_directory_const_js_1.BuildDirConst.LIBS)),this.service.getHarDependencies().filter((e=>!e.isLocal())).forEach((e=>{this.getNativeLibraryByLibs(e.getDefaultLibsDir())}))}getNativeLibraryByLibs(e){this.getLibsInfo(e).map((t=>({name:path_1.default.basename(t),path:path_1.default.resolve(e,t)}))).filter((e=>fs_extra_1.default.lstatSync(e.path).isFile())).forEach((e=>{this.setPkgContextInfoMapWithSo(e.name)}))}getNativeLibrary(e){const t=e.getTargetData().getPathInfo().getNinjaWorkDir(),o=e.getBuildOption().externalNativeOptions;if(!e.getShouldBuildCmake()||!this.useNormalizedOHMUrl)return;const n=cmake_util_js_1.CmakeUtil.checkAbiFilters(null==o?void 0:o.abiFilters,e.getTargetData().isHarmonyOS(),e.getModuleService().getModuleModel(),e.getTargetData().getTargetName());for(const e of n){const o=path_1.default.resolve(t,e);cmake_util_js_1.CmakeUtil.parseLibraries(o,this.targetName,e).forEach((e=>{const t=e.getNameOnDisk();t&&this.setPkgContextInfoMapWithSo(t)}))}}setPkgContextInfoMapWithSo(e){this.pkgContextInfoMap.has(e)||this.pkgContextInfoMap.set(e,getSoDefaultContextInfo(e))}initTaskDepends(){}}function getSoDefaultContextInfo(e){return{packageName:e,bundleName:"",moduleName:"",version:"",entryPath:"",isSO:!0,dependencyAlias:""}}exports.GeneratePkgContextInfo=GeneratePkgContextInfo,exports.getSoDefaultContextInfo=getSoDefaultContextInfo;