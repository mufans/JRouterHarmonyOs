"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.mergeSigningConfig=exports.getSigningConfig=exports.isSigned=exports.SignUtil=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),find_target_product_js_1=require("../../common/find-target-product.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),common_const_js_1=require("../../const/common-const.js"),sign_type_enum_js_1=require("../../enum/sign-type-enum.js"),error_code_map_js_1=require("../../error/error-code-map.js"),array_util_1=require("../../utils/array-util"),file_util_js_1=require("../../utils/file-util.js"),inject_util_js_1=require("../../utils/inject-util.js"),keystore_utils_js_1=require("../../utils/keystore-utils.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),process_utils_1=require("../../utils/process-utils"),validate_util_js_1=require("../../utils/validate/validate-util.js"),module_task_service_1=require("../service/module-task-service"),sign_command_factory_1=require("./command-builder-impl/sign-command-factory"),sign_request_js_1=require("./sign-request.js");class SignUtil{constructor(e,t,i,n,o){this._log=ohos_logger_js_1.OhosLogger.getLogger(SignUtil.name);const s=e.getProjectModel().getCompileApiMetaByProduct(n.name).version;this._taskService=e,this._signType=t,this._targetProduct=n,this._signCommandFactory=new sign_command_factory_1.SignCommandFactory(s),this._pathInfo=i,this.sdkInfo=o}get _signingConfig(){return this.getSigningConfig()}get _signingConfigCheckLogStr(){return this.signingConfigCheckLogStr=void 0,this.getSigningConfig(),this.signingConfigCheckLogStr}async sign(e,t){var i,n;if(e.getSignType()!==sign_type_enum_js_1.SignTypeEnum.HAR){if(inject_util_js_1.InjectUtil.isDaemon()&&this.sdkInfo.supportHapSignToolApiCall(!this.sdkInfo.isOhos))try{await this.executeSignRequest(e,t)}catch(i){this._log.debug(`java daemon remote sign failed ${null==i?void 0:i.code} ${null==i?void 0:i.message} fallback to local java -jar sign`),await this.executeSign(e,t)}else await this.executeSign(e,t);fs_extra_1.default.existsSync(e.getOutPutFilePath())||e.getSignType()!==sign_type_enum_js_1.SignTypeEnum.SHELL||fs_extra_1.default.copyFileSync(e.getInputFilePath(),e.getOutPutFilePath())}else try{await this.executeSignRequest(e,t)}catch(e){this._log.debug(`Remote sign har failed. errorCode: ${null!==(i=null==e?void 0:e.code)&&void 0!==i?i:""}`),this._log.errorMessageExit(`Remote sign har failed. ${null!==(n=null==e?void 0:e.message)&&void 0!==n?n:""}`)}}getSignCommand(e){if(!this._signingConfig)return;return this._signCommandFactory.createCommandBuilder(this._taskService.getProjectModel(),this._signingConfig,this.sdkInfo,e).getSignCommand()}getBundleNameFromHap(e){return validate_util_js_1.ValidateUtil.getBundleNameFromHap(this._targetProduct,e)}getVerifySignCommands(e){return validate_util_js_1.ValidateUtil.getVerifySignCommands(this.sdkInfo,this._signingConfig,e)}async validateBundleName(e,t,i,n=!1){const o=this._taskService.getProjectModel(),s=this._taskService.isFaMode()?common_const_js_1.CommonConst.CONFIG_JSON:common_const_js_1.CommonConst.APP_CONFIG;if((null==e?void 0:e.getSignType())===sign_type_enum_js_1.SignTypeEnum.HAP||(null==e?void 0:e.getSignType())===sign_type_enum_js_1.SignTypeEnum.HOS_HAP){const e=await validate_util_js_1.ValidateUtil.getBundleNameFromP7b(this.sdkInfo,this._signingConfig,t,i,n);if(validate_util_js_1.ValidateUtil.getBundleNameFromHap(this._targetProduct,o)!==e){const e="BundleName in the project configuration does not match that in the SigningConfigs.",t=`Open the project-level build-profile.json5 file. Change the bundleName value\n        to that in the SigningConfigs. Otherwise, go to the ${s} file and change the bundleName value there.`;this._log._buildError(e)._solution(t)._file(this._taskService.getProjectModel().getProfilePath())._errorCode(error_code_map_js_1.ECM.DECE.SERVICE_LOGIC)._printErrorAndExit()}}}async executeSign(e,t){const i=this._signingConfig;if(!i)return;const n=`generate ${e.getSignType()} signing command`,o=t.createSubEvent(n,"");o.start();const s=this._signCommandFactory.createCommandBuilder(this._taskService.getProjectModel(),i,this.sdkInfo,e).getSignCommand(),g=`execute ${e.getSignType()} signing command`;if((0,wdk_1.isEqual)(i,SignUtil.getDefaultSign())){o.stop(),o.setLog(n,hvigor_1.MetricLogType.INFO);const i=t.createSubEvent(g,"");return i.start(),await new process_utils_1.ProcessUtils(this._taskService.getNode().getName(),`Sign${e.getSignType()}`).execute(s),i.stop(),void i.setLog(g,hvigor_1.MetricLogType.INFO)}await this.validateBundleName(e,this._pathInfo,o),o.stop(),o.setLog(n,hvigor_1.MetricLogType.INFO);const r=t.createSubEvent(g,"");r.start(),this._taskService instanceof module_task_service_1.ModuleTaskService?await new process_utils_1.ProcessUtils(this._taskService.getModuleModel().getName(),`Sign${e.getSignType()}`).execute(s):await new process_utils_1.ProcessUtils(this._taskService.getProjectModel().getName(),`Sign${e.getSignType()}`).execute(s),r.stop(),r.setLog(g,hvigor_1.MetricLogType.INFO)}async executeSignRequest(e,t){const i=this._signingConfig;if(!i)return;const n=`generate ${e.getSignType()} signing command`,o=t.createSubEvent(n,"");o.start();const s=this._signCommandFactory.createCommandBuilder(this._taskService.getProjectModel(),i,this.sdkInfo,e),g=(s.getSignCommand(),`execute ${e.getSignType()} signing command`),r=async()=>{if(e.getSignType()===sign_type_enum_js_1.SignTypeEnum.HAR){const t=(0,sign_request_js_1.constructHarSignParams)(i,e.getInputFilePath(),e.getOutPutFilePath(),s.readKeyStorePwd(),s.readKeyPwd());await(0,sign_request_js_1.sendSignHarRequest)(s.getSignTool(),t)}else{const t=e.getSignType()===sign_type_enum_js_1.SignTypeEnum.BIN?"bin":"zip",n=(0,sign_request_js_1.constructSignParams)(i,e.getInputFilePath(),e.getOutPutFilePath(),s.readKeyStorePwd(),s.readKeyPwd(),t);await(0,sign_request_js_1.sendSignRequest)(s.getSignTool(),n)}};if((0,wdk_1.isEqual)(i,SignUtil.getDefaultSign())){o.stop(),o.setLog(n,hvigor_1.MetricLogType.INFO);const e=t.createSubEvent(g,"");return e.start(),await r(),e.stop(),void e.setLog(g,hvigor_1.MetricLogType.INFO)}await this.validateBundleName(e,this._pathInfo,o,!0),o.stop(),o.setLog(n,hvigor_1.MetricLogType.INFO);const a=t.createSubEvent(g,"");a.start(),await r(),a.stop(),a.setLog(g,hvigor_1.MetricLogType.INFO)}getSigningConfig(){var e;const t=this._taskService.getProjectModel().getProfileOpt().app,i=this._targetProduct.signingConfig,n=(0,wdk_1.cloneDeep)(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.signingConfig);if(void 0===i)return n||void(this.signingConfigCheckLogStr=`No signingConfig found for product ${this._targetProduct.name}`);const o=(0,array_util_1.getElementFromArr)(null==t?void 0:t.signingConfigs,i.substring(i.lastIndexOf(".")+1));return void 0===o?n||void(this.signingConfigCheckLogStr=`Will skip sign '${this._signType}'. No signingConfigs profile is configured in current project.\n             If needed, configure the signingConfigs in ${this._taskService.getProjectModel().getProfilePath()}.`):mergeSigningConfig(o,n)}static getDefaultSign(){return{material:{storeFile:keystore_utils_js_1.KeyStoreHelper.getDefaultDebugKeyStoreLocation(),storePassword:keystore_utils_js_1.KeyStoreHelper.DEFAULT_STORE_PASS,keyAlias:keystore_utils_js_1.KeyStoreHelper.DEFAULT_ALIAS,keyPassword:keystore_utils_js_1.KeyStoreHelper.DEFAULT_STORE_PASS,signAlg:"",profile:"",certpath:""},name:""}}static isUseDefaultShellSign(e){const t=SignUtil.getDefaultSign().material;return e.storePassword===t.storePassword&&e.keyPassword===t.keyPassword&&e.storeFile===t.storeFile&&e.keyAlias===t.keyAlias}static getSigningConfigInputs(e,t){var i,n,o,s,g,r;const a=new Map;if(a.set(common_const_js_1.CommonConst.ENABLE_SIGN_TASK,hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.ENABLE_SIGN_TASK)),a.set("sdkToolchainsComponentVersion",e.getToolchainsComponentVersion()),!t)return a.set("existSigningConfig",!1),a;a.set("existSigningConfig",!0).set("signingConfig_name",null!==(i=t.name)&&void 0!==i?i:"").set("signingConfig_type",null!==(n=t.type)&&void 0!==n?n:"");const l=t.material;return l?(a.set("existMaterial",!0).set("signingConfig_signAlg",null!==(o=l.signAlg)&&void 0!==o?o:"").set("signingConfig_keyAlias",null!==(s=l.keyAlias)&&void 0!==s?s:"").set("signingConfig_keyPassword",null!==(g=l.keyPassword)&&void 0!==g?g:"").set("signingConfig_storePassword",null!==(r=l.storePassword)&&void 0!==r?r:""),a):(a.set("existMaterial",!1),a)}getSigningConfigInputFiles(){var e;const t=new hvigor_1.FileSet,i=null===(e=this._signingConfig)||void 0===e?void 0:e.material;return(null==i?void 0:i.certpath)&&t.addEntry(file_util_js_1.FileUtil.convertToAbsolutePath(i.certpath,this._taskService.getProjectModel().getProjectDir()),{isDirectory:!1}),(null==i?void 0:i.profile)&&t.addEntry(file_util_js_1.FileUtil.convertToAbsolutePath(i.profile,this._taskService.getProjectModel().getProjectDir()),{isDirectory:!1}),(null==i?void 0:i.storeFile)&&t.addEntry(file_util_js_1.FileUtil.convertToAbsolutePath(i.storeFile,this._taskService.getProjectModel().getProjectDir()),{isDirectory:!1}),t}}exports.SignUtil=SignUtil;const isSigned=(e,t=!1)=>!!getSigningConfig(e)&&(t?!!hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.HvigorConfigConst.OHOS_SIGN_HAR):!!hvigor_1.hvigorCore.getParameter().getProperty(common_const_js_1.CommonConst.ENABLE_SIGN_TASK));function getSigningConfig(e){var t;const i=(0,find_target_product_js_1.findTargetProduct)(e),n=e.getProfileOpt().app,o=i.signingConfig,s=(0,wdk_1.cloneDeep)(null===(t=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===t?void 0:t.signingConfig);if(void 0===o)return s;const g=(0,array_util_1.getElementFromArr)(null==n?void 0:n.signingConfigs,o.substring(o.lastIndexOf(".")+1));return void 0===g?s:mergeSigningConfig(g,s)}function mergeSigningConfig(e,t){var i,n,o;return{material:{...e.material,...null!==(i=null==t?void 0:t.material)&&void 0!==i?i:{}},name:null!==(n=e.name)&&void 0!==n?n:null==t?void 0:t.name,type:null!==(o=e.type)&&void 0!==o?o:null==t?void 0:t.type}}exports.isSigned=isSigned,exports.getSigningConfig=getSigningConfig,exports.mergeSigningConfig=mergeSigningConfig;