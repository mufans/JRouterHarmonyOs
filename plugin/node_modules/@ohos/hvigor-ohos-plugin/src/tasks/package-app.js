"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageApp=void 0;const hvigor_1=require("@ohos/hvigor"),hvigor_2=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../builder/inner-java-command-builder/packing-tool-options.js"),file_util_js_1=require("../utils/file-util.js"),process_utils_js_1=require("../utils/process-utils.js"),base_pack_app_task_js_1=require("./base/base-pack-app-task.js"),task_names_js_1=require("./common/task-names.js"),generate_pack_res_js_1=require("./generate-pack-res.js");var Task=task_names_js_1.TaskNames.Task;const build_directory_const_js_1=require("../const/build-directory-const.js"),module_task_service_js_1=require("./service/module-task-service.js"),hvigor_config_loader_js_1=require("@ohos/hvigor/src/common/util/hvigor-config-loader.js"),common_const_js_1=require("../const/common-const.js"),remote_hsp_utils_js_1=require("../utils/remote-hsp-utils.js");class PackageApp extends base_pack_app_task_js_1.BasePackAppTask{constructor(e,t){super(e,t,Task.PACKAGE_APP),this.allDestDir=[],this.allSrcHapPath=[],this.allDestHapPath=[],this.allSrcHspPath=[],this.allDestHspPathList=[],this.allRemoteHspPathMap=new Map,this.remoteHspModuleSet=new Set,this.projectBuildProfilePath="",this.defaultPackageLimitSize=2,this.projectBuildProfilePath=t.getProjectModel().getProfilePath(),this.curProduct=t.getTargetProduct(),this.projectModel=t.getProjectModel()}declareExecutionCommand(){return`${this.getPackAppCommand().toString()}`}declareInputs(){return(new Map).set("allDestDir",this.allDestDir)}declareInputFiles(){const e=(new hvigor_2.FileSet).addEntries([this.packInfoPath,...this.allSrcHapPath,...this.allSrcHspPath],{isDirectory:!1});return this.needPackRes&&e.addEntry(this.packResPath,{isDirectory:!0}),e}declareOutputFiles(){return super.declareOutputFiles().addEntries([path_1.default.resolve(this.service.getPathInfo().getProjectOutputPath(),this.service.getAppOutputFileName()),...this.allDestHapPath,...this.allDestHspPathList],{isDirectory:!1})}initTaskDepends(){this.dependsOn(generate_pack_res_js_1.GeneratePackRes.name)}async beforeAlwaysAction(){this.service.getProductDataMap().forEach((e=>{for(const t of e){const e=t.getPathInfo().getModuleBuildOutputPath();t.getModuleModel().isHapModule()?this.initWithHapModuleData(t,e):this.initWithHspModuleData(t,e);const s=t.getModuleModel(),a=s.getRemoteHspPath();this.remoteHspModuleSet.has(s.getName())||((0,remote_hsp_utils_js_1.initSignRemoteHspMap)(a,this.allRemoteHspPathMap),this.remoteHspModuleSet.add(s.getName()))}}));const e=this.service.getProjectModel().getRemoteHspPath();(0,remote_hsp_utils_js_1.initSignRemoteHspMap)(e,this.allRemoteHspPathMap);[...this.allRemoteHspPathMap.values()].forEach((e=>{const t=this.projectModel.getCacheIntegratedHspPath(this.curProduct.name),s=e.isIntegratedHsp?path_1.default.resolve(t,e.hspDirName,e.hspFileName):e.hspPath;this.allDestHspPathList.push(s)}))}async doTaskAction(){const e="generate app packaging command",t=this.durationEvent.createSubEvent(e,"");t.start(),await this.getUnpackedHaps();const s=this.getPackAppCommand();this._log._printDebugCommand("PackageApp",s),t.stop(),t.setLog(e,hvigor_1.MetricLogType.INFO);const a="execute app packaging command",i=this.durationEvent.createSubEvent(a,"");i.start(),await(new process_utils_js_1.ProcessUtils).execute(s),i.stop(),i.setLog(a,hvigor_1.MetricLogType.INFO)}getPackAppCommand(){const e=new packing_tool_options_js_1.PackingToolOptions;e.addCalledJarFile(this.packageTool),this.needPackRes&&fs_extra_1.default.existsSync(this.packResPath)&&e.addPackResPath(this.packResPath),e.addMode("app").addPackInfoPath(this.packInfoPath).addHapPath(this.allDestHapPath.join(",")).addHspPath(this.allDestHspPathList.join(",")).force(!0).addOutPath(path_1.default.resolve(this.service.getPathInfo().getProjectOutputPath(),this.service.getAppOutputFileName())).addMainModuleLimit(this.defaultPackageLimitSize).addNormalModuleLimit(this.defaultPackageLimitSize);const t=hvigor_config_loader_js_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(common_const_js_1.HvigorConfigConst.OHOS_PACK_COMPRESS_LEVEL);return t&&e.addCompressLevel(t,this.service.getSdkInfo().getSdkVersion()),e.build()}async getUnpackedHaps(){for(const e of this.allDestDir)file_util_js_1.FileUtil.checkDirWithoutDelete(e);const e=[],t=[];this.checkOutputName(this.allSrcHapPath);for(let t=0;t<this.allSrcHapPath.length;t++)e.push(fs_extra_1.default.copy(this.allSrcHapPath[t],this.allDestHapPath[t]));this.checkOutputName(this.allSrcHspPath);for(let e=0;e<this.allSrcHspPath.length;e++)t.push(fs_extra_1.default.copy(this.allSrcHspPath[e],this.allDestHspPathList[e]));await Promise.all([...e,...t])}initWithHapModuleData(e,t){const s=e.getModuleTargetOutputFileName("",!1),a=path_1.default.resolve(t,"app");this.allDestDir.push(a);let i=e.getRelatedEntryModules();const o=e.getModuleModel().getModuleType();if(module_task_service_js_1.ModuleTaskService.checkEntryModules(o,i)){this.service.isFaMode()||(i=[i[0]]);for(const s of i){const i=e.getModuleTargetOutputFileName(s,!1),o=path_1.default.resolve(t,i),l=path_1.default.resolve(a,i.replace("-unsigned",""));this.allSrcHapPath.push(o),this.allDestHapPath.push(l)}}else if(e.isSingleDeviceTypeTarget()){const e=path_1.default.resolve(t,s),i=path_1.default.resolve(a,s.replace("-unsigned",""));this.allDestDir.push(a),this.allSrcHapPath.push(e),this.allDestHapPath.push(i)}else e.getTargetDeviceTypeClasses().forEach((s=>{const i=e.getModuleTargetOutputFileName("",!1,void 0,s),o=path_1.default.resolve(t,i),l=path_1.default.resolve(a,i.replace("-unsigned",""));this.allDestDir.push(a),this.allSrcHapPath.push(o),this.allDestHapPath.push(l)}))}initWithHspModuleData(e,t){const s=e.getModuleTargetOutputFileName("",!1,build_directory_const_js_1.BuildArtifactExtension.DOT_HSP),a=path_1.default.resolve(t,s),i=path_1.default.resolve(t,"app");this.allDestDir.push(i);const o=path_1.default.resolve(i,s.replace("-unsigned",""));this.allSrcHspPath.push(a),this.allDestHspPathList.push(o)}checkOutputName(e){const t=new Set;e.forEach((e=>{const s=e.slice(e.lastIndexOf(path_1.default.sep)+1),a=`The customized output name: ${s}, please check the module target configuration in project.`;t.has(s)?this._log._buildError("Failed to build the app due to duplicate customized output names in the current project.")._detail(a)._file(path_1.default.resolve(e))._printErrorAndExit():t.add(s)}))}}exports.PackageApp=PackageApp;