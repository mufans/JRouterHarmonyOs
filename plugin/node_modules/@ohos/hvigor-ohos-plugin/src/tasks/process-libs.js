"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,r)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessLibs=void 0;const hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),cmake_util_js_1=require("../utils/cmake-util.js"),file_util_js_1=require("../utils/file-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),task_names_js_1=require("./common/task-names.js"),build_native_with_ninja_js_1=require("./build-native-with-ninja.js");var Task=task_names_js_1.TaskNames.Task;const dependency_manager_1=require("../project/dependency/dependency-manager"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),process_libs_common_properties_js_1=require("./common-properties/process-libs-common-properties.js"),process_libs_js_1=require("./worker/process-libs.js");class ProcessLibs extends process_libs_common_properties_js_1.ProcessLibsCommonProperties{constructor(e){var t;super(e,Task.PROCESS_LIB),this.logger=ohos_logger_js_1.OhosLogger.getLogger(ProcessLibs.name);const s=e.getTargetData().getPathInfo();this._moduleDir=this.moduleModel.getProjectDir(),this.hapLocalLibs=path_1.default.resolve(this._moduleDir,build_directory_const_js_1.BuildDirConst.LIBS),this.collectAllLibs=!!(null===(t=this.targetService.getBuildOption().nativeLib)||void 0===t?void 0:t.collectAllLibs),this.allHarLibs=this.getAllHarLibs(),this.libsWithPkg=this.getHarLibsWithPkg(),this.libsOutputDir=s.getIntermediatesProcessLibs(),this.localOutput=s.getIntermediatesCppOutPut(),this._nativeOption=e.getBuildOption().externalNativeOptions,this.hasLocalNativeOutput=cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,this._nativeOption),this.filterRule=e.getNativeLibOption().filter,this.cangjieLibs=path_1.default.resolve(s.getIntermediatesCangjieOutPut())}async beforeAlwaysAction(){this.service.isFaMode()&&(this.allHarLibs=this.getAllHarLibs(),this.libsWithPkg=this.getHarLibsWithPkg()),this.hasLocalNativeOutput&&(this.localOutputHash=await file_util_js_1.FileUtil.hashEntry(this.localOutput,this.sdkInfo.getSdkLlvmReadElf()))}declareInputs(){const e=super.declareInputs();return void 0!==this.filterRule&&Object.entries(this.filterRule).filter((([,e])=>!!e)).forEach((([t,s])=>e.set(t,s))),this.hasLocalNativeOutput&&this.localOutputHash&&this.localOutputHash.forEach(((t,s)=>e.set(path_1.default.relative(this.localOutput,s),t))),e.set("isBundledDependencies",this.isBundledDependencies).set("isByteCodeHar",this.targetService.isByteCodeHar()),e}declareInputFiles(){const e=new hvigor_1.FileSet;fs.existsSync(this.hapLocalLibs)&&e.addEntry(this.hapLocalLibs,{isDirectory:!0});for(const t of this.allHarLibs.keys())fs.existsSync(t)&&e.addEntry(t);return fs.existsSync(this.projectModel.getProfilePath())&&e.addEntry(this.projectModel.getProfilePath()),fs.existsSync(this.moduleModel.getProfilePath())&&e.addEntry(this.moduleModel.getProfilePath()),fs.existsSync(this.cangjieLibs)&&e.addEntry(this.cangjieLibs,{isDirectory:!0}),e}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this.libsOutputDir,{isDirectory:!0})}get isBundledDependencies(){return this.targetService.isBundledDependencies()}initTaskDepends(){this.declareDepends(build_native_with_ninja_js_1.BuildNativeWithNinja.name)}async doTaskAction(){const e=path_1.default.resolve(__dirname,"./worker/process-libs.js/processLibs"),t=this.service.getDependencyInfo().getSelfAsDependency(),s=path_1.default.resolve(this._moduleDir,"libs"),i=this.pathInfo.getIntermediatesCppOutPut(),r={allHarLibs:this.libsWithPkg,outputDir:this.libsOutputDir,filterRule:this.filterRule,localLibs:(0,process_libs_js_1.buildLibs)(this.getLibsInfo(s),t,s),outputLibs:(0,process_libs_js_1.buildLibs)(this.getLibsInfo(i),t,i),profilePath:cmake_util_js_1.CmakeUtil.getMayBeOccurErrorsFilePath(this.moduleModel),moduleName:this.moduleName,cangjieLibs:(0,process_libs_js_1.buildLibs)(this.getLibsInfo(this.cangjieLibs),t,this.cangjieLibs),collectAllLibs:this.collectAllLibs},o={workInput:r};if(this.getWorkerPool().submit(this,e,o).getState()===hvigor_1.TaskState.REJECT){const e="process libs",t=this.durationEvent.createSubEvent(e,"");t.start(),this.logger.debug("Worker dispatch failed, running processLibs on main thread."),await(0,process_libs_js_1.processLibs)(r),t.stop(),t.setLog(e,hvigor_1.MetricLogType.INFO)}}getHarLibsWithPkg(){const e=[];for(const[t,s]of this.allHarLibs.entries())e.push(...(0,process_libs_js_1.buildLibs)(this.getLibsInfo(t),s,t));return e}getAllHarLibs(){const e=new Map;if(this.collectRemoteHarLibs(this.targetService,e),this.moduleModel.isHarModule()&&this.targetService.getTargetData().getTargetName()!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)return this.isBundledDependencies?(this.service.getHarModuleDependencies().forEach((t=>{const s=har_target_util_js_1.HarTargetUtil.getHarTargetData(t,this.moduleModel,this.targetService.getTargetData().getTargetName(),this.moduleName,this.targetService),i=dependency_manager_1.DependencyManager.getModuleModelByDependency(t[1],this.projectModel);if(i){const t=this.projectModel.getTarget(null==i?void 0:i.getName(),s);this.collectLocalHarLibs(t,e)}})),e):e;const t=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService);for(const[s,i]of t){const t=this.projectModel.getTarget(s,i);this.collectLocalHarLibs(t,e)}return e}collectLocalHarLibs(e,t){if(e){const s=e.getTargetData().getPathInfo().getIntermediatesProcessLibs(),i=e.getModuleService().getDependencyInfo().getSelfAsDependency();t.set(s,i),t.set(i.getDefaultLibsDir(),i)}}collectRemoteHarLibs(e,t){this.service.getRemoteHarDependencies().forEach((e=>{if(this.isBundledDependencies){if(e.isByteCodeHarDependency())return;t.set(e.getDefaultLibsDir(),e)}else{if(this.moduleModel.isHarModule()&&this.targetService.getTargetData().getTargetName()!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET)return;t.set(e.getDefaultLibsDir(),e)}}))}}exports.ProcessLibs=ProcessLibs;