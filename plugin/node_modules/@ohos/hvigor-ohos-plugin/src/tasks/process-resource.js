"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessResource=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),opt_compression_builder_js_1=require("../builder/opt-compression-builder.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),inject_util_js_1=require("../utils/inject-util.js"),abstract_process_resource_js_1=require("./abstract/abstract-process-resource.js"),task_names_js_1=require("./common/task-names.js"),unit_test_process_profile_js_1=require("./unitTest/unit-test-process-profile.js");var Task=task_names_js_1.TaskNames.Task;const ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET,_log=hvigor_1.HvigorLogger.getLogger("process-resource");class ProcessResource extends abstract_process_resource_js_1.AbstractProcessResource{constructor(e){super(e,Task.PROCESS_RESOURCE),this.resConfigFilePath=path_1.default.resolve(this.outputDir,common_const_js_1.CommonConst.RES_CONFIG_FILE),this.optCompressionFilePath=path_1.default.resolve(this.outputDir,common_const_js_1.CommonConst.OPT_COMPRESSION_FILE),this.optCompressionBuilder=this.getOptCompressionBuilder()}initTaskDepends(){super.initTaskDepends(),inject_util_js_1.InjectUtil.isUnitTestProcess()&&this.declareDepends(unit_test_process_profile_js_1.UnitTestProcessProfile.name)}beforeTask(){super.beforeTask(),fs_extra_1.default.existsSync(this.optCompressionFilePath)&&fs_extra_1.default.removeSync(this.optCompressionFilePath)}declareInputs(){const e=super.declareInputs();return e.set(this.optCompressionFilePath,JSON.stringify(this.optCompressionBuilder.getOptCompressionObj())),e}doTaskAction(){const e=this.optCompressionBuilder.getOptCompressionObj();fs_extra_1.default.outputJSONSync(this.optCompressionFilePath,e),this.restoolConfigBuilder.addCompression(this.optCompressionFilePath),super.doTaskAction()}declareOutputFiles(){const e=super.declareOutputFiles();return e.addEntry(this.optCompressionFilePath,{isDirectory:!1}),e}getAppResourceDir(){var e;const s=this.targetData.getProduct();return void 0!==s.resource&&0!==s.resource.directories.length?path_1.default.resolve(this.projectModel.getProjectDir(),null===(e=s.resource)||void 0===e?void 0:e.directories[0]):this.projectModel.getAppRes().getResourcePath()}initCommandBuilder(){(this.service.getModuleModel().isHapModule()||this.service.getModuleModel().isHspModule()||this.targetName===ohosTestTargetName)&&this.restoolConfigBuilder.addInputDir(this.getAppResourceDir(),"App");const e=this.projectModel.getAppRes().getAppResOpt().app.bundleName,s=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),"ids_map");if(this.restoolConfigBuilder.addJsonFile(this.processedJson).addModulePackName(e).addOutputDir(this.outputDir).addResTable(path_1.default.resolve(this.pathInfo.getGenerateSourceR(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_H)).addIdsPath(s).addDefinedIds(path_1.default.resolve(s,"id_defined.json")),!this.sdkInfo.isOhos){const e=path_1.default.resolve(this.sdkInfo.getHosToolchainsDir(),"id_defined.json");fs_1.default.existsSync(e)&&this.restoolConfigBuilder.addDefinedSysIds(e)}this.isEnabledIconCheck()&&this.restoolConfigBuilder.setIconCheck(!0),this.targetData.getTargetName()===ohosTestTargetName&&(this.addOhosTestExtraCompilationResources(this.restoolConfigBuilder),this.addIntermediatesSrcResource(this.restoolConfigBuilder,this.moduleModel.getSourceRootByTargetName(ohosTestTargetName)))}getOptCompressionBuilder(){var e,s;const t=null===(e=this.targetService.getBuildOption().resOptions)||void 0===e?void 0:e.compression,o=this.targetData.isHarmonyOS()&&((null===(s=null==t?void 0:t.media)||void 0===s?void 0:s.enable)||Array.isArray(null==t?void 0:t.filters)&&t.filters.length>0)&&(this.service.getModuleModel().isHapModule()||this.service.getModuleModel().isHspModule()),r=new opt_compression_builder_js_1.OptCompressionBuilder;if(r.setExtensionPath(this.sdkInfo.getLibimageTranscoderShared()),o){const e=`https://developer.huawei.com/consumer/${(0,hvigor_1.getOsLanguage)()}/doc/harmonyos-guides-V5/ide-hvigor-build-profile-V5`;_log.warn(`You have enabled the resource compression function, which will change the resource file name and data format. In some cases, you may experience problems with abnormal image displaying, in particular the disappearance of the layered launcher icon.\nYou can set the filter parameters to exclude these files, or to include the files you just need.\nFor details, see compression option in ${e}`);const s=[...this.restoolConfigBuilder.getResourceDir(),this.getAppResourceDir()];r.setResourceDirArr(s).setCompressionConfig(t)}return r}}exports.ProcessResource=ProcessResource;