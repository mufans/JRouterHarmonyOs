"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessHarArtifacts=void 0;const wdk_1=require("@baize/wdk"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_util_js_1=require("../../common/common-util.js"),find_target_product_js_1=require("../../common/find-target-product.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),dependency_interface_js_1=require("../../project/dependency/core/dependency-interface.js"),har_target_util_js_1=require("../../utils/har-target-util.js"),json_util_js_1=require("../../utils/json-util.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../../utils/ohmurl-utils.js"),validate_systemHsp_js_1=require("../../utils/validate/validate-systemHsp.js"),validate_util_js_1=require("../../utils/validate/validate-util.js"),cache_native_libs_js_1=require("../cache-native-libs.js"),task_names_js_1=require("../common/task-names.js"),compile_resource_js_1=require("../compile-resource.js"),process_obfuscation_files_js_1=require("./process-obfuscation-files.js");var Task=task_names_js_1.TaskNames.Task;const hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),dependency_manager_js_1=require("../../project/dependency/dependency-manager.js"),file_util_js_1=require("../../utils/file-util.js"),parameter_utils_js_1=require("../../utils/parameter-utils.js"),abstract_process_har_artifacts_js_1=require("../abstract/abstract-process-har-artifacts.js"),DECLARE_FILE_OUTPUT=build_directory_const_js_1.BuildDirConst.DECLARE_FILE_OUTPUT;class ProcessHarArtifacts extends abstract_process_har_artifacts_js_1.AbstractProcessHarArtifacts{constructor(e){super(e,Task.PROCESS_HAR_ARTIFACTS),this.logger=ohos_logger_js_1.OhosLogger.getLogger(ProcessHarArtifacts.name),this.arkTsCompiledOutputDir=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath()),this.compiledAbcOutputDir=path_1.default.resolve(this.arkTsCompiledOutputDir,code_type_enum_js_1.CodeType.ETS);const t=path_1.default.relative(this.moduleModel.getBelongProjectPath(),this.moduleModel.getProjectDir());this.declaredFilesOutputDir=path_1.default.resolve(this.arkTsCompiledOutputDir,DECLARE_FILE_OUTPUT,t);const s=this.projectModel.getAppRes();this.appOptObj=s.getAppResOpt();const r=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.targetModuleOptObj=r.getModuleJsonOpt(),this.targetJsonPath=r.getJsonPath(),this.ohPkgMetadataResDir=[],this.nonEntryImportees=[]}get isBundledDependencies(){return this.targetService.isBundledDependencies()}get isNativeStripped(){var e,t,s,r;return null===(r=null===(s=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.nativeLib)||void 0===t?void 0:t.debugSymbol)||void 0===s?void 0:s.strip)||void 0===r||r}declareInputs(){var e,t,s,r,i;const a=(0,wdk_1.cloneDeep)(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt),o=super.declareInputs().set("bundleType",null!==(s=null!==(t=null==a?void 0:a.bundleType)&&void 0!==t?t:(0,find_target_product_js_1.findTargetProduct)(this.service.getProjectModel()).bundleType)&&void 0!==s?s:this.projectModel.getBundleType()).set("isByteCodeHar",this.targetService.isByteCodeHar()).set("harLocalDependencyCheck",!!(null===(r=this.targetService.getBuildOption().strictMode)||void 0===r?void 0:r.harLocalDependencyCheck)).set("isBundledDependencies",this.isBundledDependencies).set("nonEntryImportees",this.nonEntryImportees).set("isDebug",this.targetService.isDebug()).set("isNativeStripped",this.isNativeStripped),n=null===(i=this.targetService.getTargetData().getTargetOpt().resource)||void 0===i?void 0:i.directories;return n&&o.set("targetDirectories",n),o}declareInputFiles(){const e=super.declareInputFiles();return fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),e}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.collectNonEntryImportees()}initTaskDepends(){this.declareDependsList(cache_native_libs_js_1.CacheNativeLibs.name,compile_resource_js_1.CompileResource.name),this.addSpecialDepends()}addSpecialDepends(){if(this._harExtendInfo.isObfuscatedHar()){const e=this.sdkInfo.hasRollUpPluginInEtsLoader;this.declareDepends(e?"HarCompileArkTS":"HarBuildArkTS")}else this.declareDepends(common_const_js_1.ArktSTaskConst.LINT_ARKTS);this.declareDepends(this.moduleModel.isOhpmProject()?Task.PROCESS_OH_PACKAGE_JSON.name:Task.PROCESS_PACKAGE_JSON.name),this.declareDepends(process_obfuscation_files_js_1.ProcessObfuscationFiles.name)}copyCompiledSourceFileToTempDir(){if(this.targetService.isByteCodeHar()){if(fs_extra_1.default.existsSync(this.compiledAbcOutputDir)&&fs_extra_1.default.copySync(this.compiledAbcOutputDir,path_1.default.join(this.taskTmpDir,path_1.default.basename(this.compiledAbcOutputDir))),fs_extra_1.default.existsSync(this.declaredFilesOutputDir)){fs_extra_1.default.copySync(this.declaredFilesOutputDir,this.taskTmpDir);const e=path_1.default.resolve(this.taskTmpDir,this.pathInfo.getBuildRoot());fs_extra_1.default.existsSync(e)&&fs_extra_1.default.removeSync(e)}}else fs_extra_1.default.existsSync(this.arkTsCompiledOutputDir)&&fs_extra_1.default.copySync(this.arkTsCompiledOutputDir,this.taskTmpDir)}processBundleDepRes(){var e;if(!this.targetService.isBundledDependencies())return;const t=`${build_directory_const_js_1.BuildDirConst.SRC}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.MAIN}${path_1.default.sep}${build_directory_const_js_1.BuildDirConst.RESOURCES}`,s=null===(e=this.targetService.getTargetData().getTargetOpt().resource)||void 0===e?void 0:e.directories;(null==s?void 0:s.length)?this.ohPkgMetadataResDir.push(...s):this.ohPkgMetadataResDir.push(t);const r=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService);r&&r.dep2Resources.forEach(((e,t)=>{this.copyBundledDepRes(e,t)}))}copyBundledDepRes(e,t){const s=(0,json_util_js_1.getJson5Obj)(path_1.default.resolve(t.getDependencyRootPath(),common_const_js_1.CommonConst.OH_PACKAGE_JSON5));e.forEach((e=>{this.ohPkgMetadataResDir.push(`${e}-${s.name}`);const r=path_1.default.resolve(t.getDependencyRootPath(),e);if(fs_extra_1.default.existsSync(r)){const t=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,`${path_1.default.basename(e)}-${s.name}`);fs_extra_1.default.mkdirsSync(t),file_util_js_1.FileUtil.copyDir(r,t)}}))}copyOtherGenerateFiles(){if(this._harExtendInfo.isObfuscatedHar())fs_extra_1.default.readdirSync(this.generateDir).forEach((e=>{const t=path_1.default.resolve(this.generateDir,e);fs_extra_1.default.copySync(t,path_1.default.resolve(this.taskTmpDir,e))}));else try{fs_extra_1.default.copySync(oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.generateDir,this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON)),oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(this.taskTmpDir,this.isOhpmProject?common_const_js_1.CommonConst.OH_PACKAGE_JSON5:common_const_js_1.CommonConst.PACKAGE_JSON)))}catch(e){this.logger.warn(e.message)}}processHarRouterMap(){const e=this.moduleModel.getJsonPathByTargetName(this.targetName),t=res_model_loader_js_1.resModelLoader.getModuleJson(e).module.routerMap,s=(0,common_util_js_1.parsingProfileName)(t);if(!s)return;const r=path_1.default.resolve(this.targetData.getPathInfo().getIntermediatesResProfilePath(),`${s}.json`),i=path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR,`${s}.json`),a=(0,json_util_js_1.getJson5Obj)(r);if(!this.targetService.isOpenSource()){const e=path_1.default.resolve(this.pathInfo.getModuleBuildCachePath(),`${this.targetName}@HarCompileArkTS`,"esmodule","release","obfuscation","nameCache.json"),t=(0,json_util_js_1.getJson5Obj)(e);a.routerMap.forEach((e=>{const s=this.getObfuscatedPageSourceFile(this.moduleModel,e,t);s&&Object.assign(e,{pageSourceFile:s})}))}a.routerMap.map((e=>delete e.originalSuffix)),fs_extra_1.default.writeFileSync(i,JSON.stringify(a))}processDeclarationEntry(e){var t,s,r,i,a,o,n,l;if(!this.targetService.isByteCodeHar())return void this.logger.debug("Since current module is not byte code har, just return.");const d=(null===(s=null===(t=e.metadata)||void 0===t?void 0:t.runtimeOnly)||void 0===s?void 0:s.sources)||[],c=(null===(r=e.metadata)||void 0===r?void 0:r.workers)||[];null===(i=e.metadata)||void 0===i||delete i.workers,null===(o=null===(a=e.metadata)||void 0===a?void 0:a.runtimeOnly)||void 0===o||delete o.sources;const _=this.pathInfo.getIntermediatesPkgContextInfoPath(),u=(0,json_util_js_1.getJson5Obj)(_),p=u[this.packageJsonObj.name];if(!p)return void this.logger.debug(`Can not find package context information with package name: ${this.packageJsonObj.name}`);const h=[];this.isBundledDependencies&&(this.collectConfigOhmurl(null===(n=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService))||void 0===n?void 0:n.dep2Workers,u,h),this.collectRuntimeOnlyOhmurl(u,h),this.collectConfigOhmurl(null===(l=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService))||void 0===l?void 0:l.dep2RouterMapObjPageSourceFiles,u,h));const g=[...c,...d];g.length&&g.forEach((e=>{h.push((0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(p,e.replace(/^\.\//,"")))})),e.metadata={...e.metadata,declarationEntry:h}}collectNonEntryImportees(){if(!this.targetService.isByteCodeHar()||this.isBundledDependencies)return;const e=this.moduleModel.getCompileMode(this.targetService.getTargetData().getProduct()),t=path_1.default.resolve(this.pathInfo.getModuleBuildCachePath(),`${this.targetName}@HarCompileArkTS`,e,this.targetService.getBuildMode().toLowerCase(),hvigor_arkts_compose_1.NON_ENTRY_IMPORTEE_CACHE_FILE_NAME);if(!fs_extra_1.default.existsSync(t))return;const s=new Set,r=this.service.getDirectDependencies(),i=(0,json_util_js_1.getJson5Obj)(t);if(!Array.isArray(i))return;i.forEach((e=>{const t=r.find((t=>e.startsWith(t.getDependencyName())));t&&t.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER&&s.add(e)}));const a=Array.from(s);a.sort(((e,t)=>e>t?1:-1)),this.nonEntryImportees=a}hasSoFile(){const e=[this.processedLibs];for(;e.length;){const t=e.pop();for(const s of fs_extra_1.default.readdirSync(t)){const r=path_1.default.resolve(t,s),i=fs_extra_1.default.lstatSync(r);if(i.isFile()&&!s.endsWith(".a"))return!0;i.isDirectory()&&e.push(r)}}return!1}processPackageJson(){var e;const t=path_1.default.basename(this.packageManagerPath),s=path_1.default.resolve(this.taskTmpDir,t);if(!fs_extra_1.default.existsSync(s))return;const r=(0,json_util_js_1.getJson5Obj)(s),i=r.types;if(i){const e=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),i);fs_extra_1.default.existsSync(e)&&fs_extra_1.default.copyFileSync(e,path_1.default.resolve(this.taskTmpDir,i))}r.metadata||(r.metadata={});const a=[...(null===(e=this.targetData.getTargetOpt().source)||void 0===e?void 0:e.sourceRoots)||[],`./${build_directory_const_js_1.BuildDirConst.SRC}/${build_directory_const_js_1.BuildDirConst.MAIN}`];if(Object.assign(r.metadata,{sourceRoots:a,debug:this.targetService.isDebug()}),this.isBundledDependencies){if(Object.assign(r.metadata,{bundleDependencies:this.isBundledDependencies}),this.ohPkgMetadataResDir&&0!==this.ohPkgMetadataResDir.length){const e=[];this.ohPkgMetadataResDir.forEach((t=>{e.push(path_1.default.normalize(t))}));const t={directories:e};Object.assign(r.metadata,{resource:t})}r.dependencies&&this.deleteOhPkgDep(dependency_interface_js_1.DependencyEnum.DEPENDENCIES,r),r.devDependencies&&delete r.devDependencies;r.dynamicDependencies&&this.deleteOhPkgDep(dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES,r)}this.processDeclarationEntry(r),this.nonEntryImportees.length&&(r.metadata.extraImportees=this.nonEntryImportees),this.hasSoFile()&&(r.metadata.nativeDebugSymbol=this.isNativeStripped),fs_extra_1.default.writeFileSync(s,JSON.stringify(r))}deleteOhPkgDep(e,t){if(!this.targetService.isByteCodeHar()||!this.isBundledDependencies||(0,parameter_utils_js_1.getPropertyKeepDependency)())return;const s=t[e];this.service.getAllDependencies().forEach((t=>{const r=t.getPackageJsonObj();r&&Object.assign(s,r[e])}));const r=this.service.getHspOrByteCodeHarDependencies().map((e=>e.getDependencyName()));for(const e in s)r.includes(e)||delete s[e]}collectRuntimeOnlyOhmurl(e,t){var s;const r=null===(s=har_target_util_js_1.HarTargetUtil.getDep2ConfigMap(this.targetService))||void 0===s?void 0:s.dep2RuntimeOnlyObj;if(!r)return;this.collectConfigOhmurl(r.dep2RuntimeOnlySources,e,t);const i=[];r.dep2RuntimeOnlyPackages.forEach((t=>{t.forEach((t=>{const s=this.service.getHarDependencies().find((e=>e.getDependencyName()===t));if(!s)return;const r=dependency_manager_js_1.DependencyManager.getModuleNameFromOhPkgJson(s.getDependencyRootPath()),a=(0,json_util_js_1.getJson5Obj)(s.getPackageFilePath()).main?s.getDependencyMainFilePath():s.getDependencyTypesFilePath(),o=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(e[r],path_1.default.relative(`${r}`,a));i.push(o)}))})),t.push(...i)}collectConfigOhmurl(e,t,s){const r=[];(null==e?void 0:e.size)&&(e.forEach(((e,s)=>{const i=dependency_manager_js_1.DependencyManager.getModuleNameFromOhPkgJson(s.getDependencyRootPath());e.forEach((e=>{const s=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(t[i],e.replace(/^\.\//,""));r.push(s)}))})),s.push(...r))}async doTaskAction(){const e=this.service.getAllDependencies();return validate_util_js_1.ValidateUtil.validateLocalDependency(this.moduleModel,this.targetService.getBuildOption(),e),(0,validate_systemHsp_js_1.validatePackageBySystemHspModel)(this.service,this.appOptObj,this.targetJsonPath,this.targetModuleOptObj),super.doTaskAction()}getObfuscatedPageSourceFile(e,t,s){const r=e.getModule().getNodeDir().substring(this.projectModel.getProjectDir().length+1),i=`${r}${path_1.default.sep}${t.pageSourceFile}`,a=i.replace(path_1.default.extname(i),t.originalSuffix),o=file_util_js_1.FileUtil.normalizePathSeparator(a);if(!Object.prototype.hasOwnProperty.call(s,o))return;const n=s[o].obfName.substring(r.length+1);return n.replace(path_1.default.extname(n),this.hasUseTsHarField()?".ts":".js")}}exports.ProcessHarArtifacts=ProcessHarArtifacts;