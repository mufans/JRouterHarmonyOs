"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,o)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MergeProfile=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),abstract_merge_profile_js_1=require("./abstract-merge-profile.js"),pre_build_js_1=require("./pre-build.js");var Task=task_names_js_1.TaskNames.Task;const project_ohos_config_manager_js_1=require("../common/global/project-ohos-config-manager.js"),array_util_js_1=require("../utils/array-util.js"),inject_util_js_1=require("../utils/inject-util.js"),fs_extra_1=__importStar(require("fs-extra")),har_target_util_js_1=require("../utils/har-target-util.js"),json_util_js_1=require("../utils/json-util.js"),hvigor_config_loader_js_1=require("@ohos/hvigor/src/common/util/hvigor-config-loader.js"),build_mode_const_js_1=require("../const/build-mode-const.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),hsp_target_utils_js_1=require("../utils/hsp-target-utils.js"),ohos_test_util_js_1=require("../utils/ohos-test-util.js"),task_util_js_1=require("../utils/task-util.js"),module_dependency_util_js_1=require("../common/module-dependency-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-merge-profile");class MergeProfile extends abstract_merge_profile_js_1.AbstractMergeProfile{constructor(e){var t,i;super(e,Task.MERGE_PROFILE),this._ohLibs=[],this._isHarModule=this.service.getModuleModel().isHarModule(),this._multiProjects=this._projectModel.getProfileOpt().app.multiProjects||!1,this._appRes=this._projectModel.getAppRes();const s=this.service.getModuleModel().getSourceSetByTargetName(this._targetName);this._moduleTargetRes=s.getModuleTargetRes(),this._mergedModuleJson=this._pathInfo.getIntermediatesMergeProfile(),this._ohLibs=this.mergeDependsLibs(common_const_js_1.CommonConst.MODULE_JSON),this._moduleBuildAbilities=null===(i=null===(t=(0,array_util_js_1.getElementFromArr)(this.moduleModel.getProfileOpt().targets,this.targetName))||void 0===t?void 0:t.source)||void 0===i?void 0:i.abilities}declareInputs(){var e,t;return super.declareInputs().set(abstract_merge_profile_js_1.INPUT_KEY.isHarModule,this._isHarModule).set(abstract_merge_profile_js_1.INPUT_KEY.multiProjects,this._multiProjects).set(abstract_merge_profile_js_1.INPUT_KEY.asanEnable,this.asanEnable).set(abstract_merge_profile_js_1.INPUT_KEY.isDebug,this.targetService.isDebug()).set(abstract_merge_profile_js_1.INPUT_KEY.buildProfileAbilities,JSON.stringify(this._moduleBuildAbilities)).set(abstract_merge_profile_js_1.INPUT_KEY.projectConfigAppOpt,JSON.stringify(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt)).set(abstract_merge_profile_js_1.INPUT_KEY.moduleJsonOpt,JSON.stringify(this._moduleTargetRes.getModuleJsonOpt())).set(abstract_merge_profile_js_1.INPUT_KEY.appJsonOpt,JSON.stringify(this._appRes.getAppResOpt())).set("integratedHsp",!!(null===(t=this.targetService.getBuildOption().arkOptions)||void 0===t?void 0:t.integratedHsp)).set("isBundledDependencies",this.isBundledDependencies)}declareInputFiles(){const e=(new hvigor_1.FileSet).addEntry(this._appRes.getJsonPath()).addEntry(this.projectModel.getProfilePath()).addEntry(this._moduleTargetRes.getJsonPath());return this._ohLibs.forEach((t=>{fs.existsSync(t)&&e.addEntry(t)})),e}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this._mergedModuleJson)}initTaskDepends(){this.declareDepends(pre_build_js_1.PreBuild.name)}initHarModuleDepends(){har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach(((e,t)=>this.declareDepends(`${e}@${Task.MERGE_PROFILE.name}`,t)))}async doTaskAction(){var e,t;const i=this.computeAppJsonOpt();this.mergeDslConfig(i),this.mergeAppEnvironmentConfig(i);const s=(0,wdk_1.cloneDeep)(this._moduleTargetRes.getModuleJsonOpt());this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(path_1.default.resolve(this._moduleTargetRes.getResourcePath(),".."))&&(s.module={...(0,ohos_test_util_js_1.getOhosTestAbilityConfig)(),...s.module}),Object.assign(s.module,{packageName:this.packageJsonObj.name});const o=this.mergeBuildProfileAbilities(s),n=this.mergeAllHarModuleOpt(o);fs_extra_1.default.existsSync(this.pathInfo.getResourceStr())&&fs.rmSync(this.pathInfo.getResourceStr(),{recursive:!0,force:!0});if(!module_dependency_util_js_1.moduleDependencyUtil.getPureHar().has(this.moduleName)){const e=n.module.requestPermissions;e&&(this.moduleModel.isHspModule()||this.moduleModel.isHarModule())&&this.checkPermissions(e),this.initResourceStr()}null===(e=s.module.proxyData)||void 0===e||e.forEach((e=>{if(this._bundleName){const t=e.uri.split("/")[2];this._appRes.getAppResOpt().app.bundleName===t&&(e.uri=e.uri.replace(t,this._bundleName))}}));const r={...i,...n};this.customizeModuleOpt(r,this.targetData.getProduct());const a=null===(t=this.targetService.getBuildOption().arkOptions)||void 0===t?void 0:t.integratedHsp;this.moduleModel.isHspModule()&&a&&(r.app.bundleName="");if(hvigor_config_loader_js_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(common_const_js_1.HvigorConfigConst.OHOS_PACK_COMPRESS_LEVEL)&&(r.module.compressNativeLibs=!0),fs_extra_1.default.existsSync(this._mergedModuleJson)){const e=(0,json_util_js_1.getJson5Obj)(this._mergedModuleJson);if(this.moduleModel.isOutModule()&&e.app.bundleName!==r.app.bundleName){_log.debug("Clean the ArkTS cache due to bundleName is changed.");const e=path_1.default.resolve(this.targetData.getPathInfo().getModuleBuildCachePath());await fs_extra_1.default.emptydir(e)}if(e.app.compileSdkVersion&&this.sdkInfo.getToolchainsComponentVersion()&&e.app.compileSdkVersion!==this.sdkInfo.getToolchainsComponentVersion()){_log.debug("Clean the ArkTS cache due to SDK version is changed.");const e=path_1.default.resolve(this.targetData.getPathInfo().getModuleBuildCachePath());await fs_extra_1.default.emptydir(e)}}fs.outputJSONSync(this._mergedModuleJson,r,{spaces:"\t"})}get isBundledDependencies(){return this.targetService.isBundledDependencies()}computeAppJsonOpt(){const e=(0,wdk_1.cloneDeep)(this._appRes.getAppResOpt());if(void 0!==e.app.multiProjects&&(_log.warn(`Field 'multiProjects' should be configured in project's build-profile.json5. The value of this field configured in app.json5 will be ignored. Please configure this field in ${this._projectModel.getProfilePath()}.`),delete e.app.multiProjects),this._isHarModule){const t={app:{bundleName:e.app.bundleName,debug:e.app.debug,versionCode:e.app.versionCode,versionName:e.app.versionName,minCompatibleVersionCode:e.app.minCompatibleVersionCode,minAPIVersion:e.app.minAPIVersion,targetAPIVersion:e.app.targetAPIVersion,apiReleaseType:e.app.apiReleaseType}};this.targetService.getTargetData().getTargetName()===common_const_js_1.CommonConst.OHOS_TEST&&Object.assign(t.app,{icon:e.app.icon,label:e.app.label,vendor:e.app.vendor}),e.app=t.app}return this.asanEnable&&(e.app.asanEnabled=this.asanEnable),this.tsanEnable&&(e.app.tsanEnabled=this.tsanEnable),e}mergeAppEnvironmentConfig(e){var t;const i=this.parseToAppEnvironments(this.appEnvironments);if(void 0!==e.app.appEnvironments&&0!==e.app.appEnvironments.length){_log.debug("Change app appEnvironment");const s=new Map;i.forEach((e=>{s.set(e.name,e.value)})),null===(t=e.app.appEnvironments)||void 0===t||t.forEach((e=>{s.set(e.name,e.value)})),e.app.appEnvironments=Array.from(s,(([e,t])=>({name:e,value:t})))}else _log.debug("Use cli appEnvironment"),e.app.appEnvironments=i}checkPermissions(e){const t=[];e.forEach((e=>{e.reason&&!t.includes(e.reason)&&t.push(e.reason.replace("$string:",""))}));const i=this._moduleTargetRes.getResourcePath(),s=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),"resource_str");0!==t.length&&this.filterResStr(i,s,t)}filterResStr(e,t,i){fs_extra_1.default.readdirSync(e).forEach((s=>{if("rawfile"!==s&&"resfile"!==s){const o=path_1.default.resolve(e,s,"element","string.json"),n={string:[]};if(fs_extra_1.default.existsSync(o)){if((0,fs_extra_1.readJSONSync)(o).string.forEach((e=>{i.includes(e.name)&&n.string.push(e)})),0===n.string.length)return;(0,task_util_js_1.getBuildModeName)()===build_mode_const_js_1.BuildModeConst.TEST&&fs_extra_1.default.outputFileSync(path_1.default.resolve(this.pathInfo.getModuleBuildIntermediates(),build_directory_const_js_1.BuildDirConst.INTERMEDIATES_RES,common_const_js_1.CommonConst.OHOS_TEST,build_directory_const_js_1.BuildDirConst.RESOURCE_STR,s,"element","string.json"),JSON.stringify(n)),fs_extra_1.default.outputFileSync(path_1.default.resolve(t,s,"element","string.json"),JSON.stringify(n))}}}))}mergeDslConfig(e){this._bundleName&&(e.app.bundleName=this._bundleName,_log.debug(`Change app bundleName with '${this._bundleName}'.`)),this._multiProjects&&(e.app.multiProjects=this._multiProjects,_log.debug(`Change app multiProjects with '${this._multiProjects}'.`)),this._vendor&&(e.app.vendor=this._vendor,_log.debug(`Change app vendor with '${this._vendor}'.`)),e.app.apiReleaseType=this.sdkInfo.getReleaseType(),_log.debug(`Change app api release type with '${this.sdkInfo.getReleaseType()}'`),this.resolveApi(e.app)}resolveApi(e){var t,i,s;const o=this.targetData.getApiMeta(),n=!![o.compileSdkVersion.version,o.compatibleSdkVersion.version,null!==(i=null===(t=o.targetSdkVersion)||void 0===t?void 0:t.version)&&void 0!==i?i:o.compileSdkVersion.version].find((e=>e<=sdk_const_js_1.ApiVersion.API_VERSION_9)),r=null!==(s=o.targetSdkVersion)&&void 0!==s?s:o.compileSdkVersion,a=this.targetData.isHarmonyOS()?this.apiTransform(r):r.version,l=this.targetData.isHarmonyOS()?this.apiTransform(o.compatibleSdkVersion):o.compatibleSdkVersion.version;e.compileSdkVersion=this.sdkInfo.getToolchainsComponentVersion(),_log.debug(`Change app compile API version with '${this.sdkInfo.getToolchainsComponentVersion()}'`),e.targetAPIVersion=n?r.version:a,_log.debug(`Change app target API version with '${e.targetAPIVersion}'`),e.minAPIVersion=n?o.compatibleSdkVersion.version:l,_log.debug(`Change app minimum API version with '${e.minAPIVersion}'`),e.compileSdkType=this.targetData.isHarmonyOS()?"HarmonyOS":"OpenHarmony"}mergeAllHarModuleOpt(e){if(this._isHarModule)return this.mergeBundledDependenciesHar(e),e;const t=this.transformJson2Opts();let i=e.module.metadata,s=e.module.requestPermissions;for(let o=0;o<t.length;o++){const n=t[o];null!==n&&(this.checkHarApiStatus(n),n.module.type!==module_type_enum_js_1.ModuleType.Har&&checkHarDeviceTypes(e,n),i=this.mergeArrayOptions(i,n.module.metadata,n.module.name),s=this.mergeHarRequestPermission(s,n))}return 0!==(null==i?void 0:i.length)&&(e.module.metadata=i),0!==(null==s?void 0:s.length)&&(e.module.requestPermissions=s),e}mergeBundledDependenciesHar(e){var t,i;if(!this.isBundledDependencies)return;const s=null!==(t=e.module.metadata)&&void 0!==t?t:[],o=null!==(i=e.module.requestPermissions)&&void 0!==i?i:[];this.service.getHarDependencies().forEach((e=>{if(e.isByteCodeHarDependency())return;const t=path_1.default.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,e.isLocal()?common_const_js_1.CommonConst.MODULE_JSON5:common_const_js_1.CommonConst.MODULE_JSON),i=(0,json_util_js_1.getJson5Obj)(t),n=i.module.metadata;this.deDuplicateArr(n,s);const r=i.module.requestPermissions;this.deDuplicateArr(r,o)})),Object.assign(e.module,{metadata:s}),Object.assign(e.module,{requestPermissions:o})}deDuplicateArr(e,t){null==e||e.forEach((e=>{t.some((t=>t.name===e.name))||t.push(e)}))}mergeDependsLibs(e){const t=this.service.getDependencyRootPaths(),i=this.service.getHarModuleDependenciesWithRootPath(),s=this.service.getHarModuleDependencyPaths(),o=this.service.getHspModuleDependencies(),n=this.service.getHspModuleDependencyPaths(),r=hsp_target_utils_js_1.HspTargetUtils.calDepHspTargets(this.targetService);return t.map((t=>{var a,l;const d=inject_util_js_1.InjectUtil.getBuildCacheParentDir(t,path_1.default.join(hvigor_1.hvigorCore.getProject().getName(),t.substring(hvigor_1.hvigorCore.getProject().getNodeDir().length)));if(n.includes(t)){const i=(null!==(a=o.find((([,e])=>e.getDependencyRootPath()===t)))&&void 0!==a?a:[""])[0],s=r.get(i);return path_1.default.resolve(d,this._buildRoot,this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.INTERMEDIATES_MERGE_PROFILE,null!==(l=null==s?void 0:s.getTargetName())&&void 0!==l?l:common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,e)}return s.includes(t)?this.getHarDenPath(i,t,d,e):path_1.default.resolve(t,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,e)}))}transformJson2Opts(){return this._ohLibs.map((e=>fs.pathExistsSync(e)?(0,json_util_js_1.getJson5Obj)(e):(_log.warn(`${e} does not exist. This library will not be merged. This may occur when the project is manually modified and the local library is not declared in ${this._projectModel.getProfilePath()}. Please confirm the correctness of this module. You may try to solve the problem by declare it in ${this.moduleModel.getName()} build-profile.json5.`),null)))}mergeHarRequestPermission(e,t){return this.mergeArrayOptions(e,t.module.requestPermissions)}mergeArrayOptions(e,t,i){const s=[],o=[];return null==e||e.forEach((e=>{s.push(e),o.push(e.name)})),null==t||t.forEach((e=>{const t=e.name;void 0!==t&&""!==t?o.includes(e.name)||s.push(e):_log.warn(`The metadata configuration in module.json5 whose name is empty or undefined in the har:${i}.\n        This configuration will not be merged.`)})),s}checkHarApiStatus(e){let t=e.app.minAPIVersion;const i=e.module.name;void 0!==t?(t.toString().length>=4&&(t=this.harMinApiVersionToAPi(t.toString())),this.targetData.getCompatibleApiVersion()<(0,wdk_1.parseInt)(t)&&_log._buildError(`The compatibleSdkVersion ${this.compatibleApiVersion} cannot be smaller than version ${t} declared in library [:${i}]\n          as the library might be using APIS not available in ${this.compatibleApiVersion}`)._printErrorAndExit(this.moduleModel.getName())):_log._buildError(`The HAR module ${i} is not undefined.Please check.`)._printErrorAndExit(this.moduleModel.getName())}harMinApiVersionToAPi(e){const t=e.length,i=e.substring(t-3,t);return(0,wdk_1.parseInt)(i)}customizeModuleOpt(e,t){var i,s,o,n,r,a,l,d,u,_,p,c,m,h;const g=(0,wdk_1.cloneDeep)(null===(i=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===i?void 0:i.appOpt),f=e.module,v=null!==(n=null!==(o=null!==(s=null==g?void 0:g.bundleType)&&void 0!==s?s:t.bundleType)&&void 0!==o?o:e.app.bundleType)&&void 0!==n?n:"app",j=e.app;j.bundleType=v,this._isHarModule||(j.label=null!==(a=null!==(r=null==g?void 0:g.label)&&void 0!==r?r:t.label)&&void 0!==a?a:j.label,j.icon=null!==(d=null!==(l=null==g?void 0:g.icon)&&void 0!==l?l:t.icon)&&void 0!==d?d:j.icon),j.versionCode=null!==(_=null!==(u=null==g?void 0:g.versionCode)&&void 0!==u?u:t.versionCode)&&void 0!==_?_:j.versionCode,j.versionName=null!==(c=null!==(p=null==g?void 0:g.versionName)&&void 0!==p?p:t.versionName)&&void 0!==c?c:j.versionName,v===common_const_js_1.BundleType.ATOMIC_SERVICE&&(f.atomicService=null!==(h=null===(m=this.targetData.getTargetOpt().config)||void 0===m?void 0:m.atomicService)&&void 0!==h?h:f.atomicService,f.installationFree=!0),v!==common_const_js_1.BundleType.APP&&v!==common_const_js_1.BundleType.SHARED||(f.installationFree=!1,f.atomicService&&delete f.atomicService),this.targetService.isDebug()&&(j.debug=!0)}mergeBuildProfileAbilities(e){var t,i,s;if(!this.moduleModel.isHapModule()||!this._moduleBuildAbilities||!e.module.abilities)return this.moduleModel.isHspModule()&&this._moduleBuildAbilities&&_log.warn("hsp module does not support to custome icon/label/lauchType in buildProfile"),e;const o=e.module.abilities.map((e=>e.name));for(const n of this._moduleBuildAbilities)for(const r of e.module.abilities)n.name&&o.includes(n.name)?r.name===n.name&&(r.icon=null!==(t=n.icon)&&void 0!==t?t:r.icon,r.label=null!==(i=n.label)&&void 0!==i?i:r.label,r.launchType=null!==(s=n.launchType)&&void 0!==s?s:r.launchType):_log.warn(`The ability name :${n.name} in build-profile can't find correspond ability name\n            in module.json.`);return e}initResourceStr(){[...this.service.getHspDependencies(),...this.service.getHarDependencies()].forEach((e=>{let t;t=e.isLocal()?this.pathInfo.getDependencyResourceStr(e.getDependencyRootPath()):e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR?path_1.default.resolve(e.getDependencyRootPath(),"src","main","resources"):path_1.default.resolve(e.getDependencyRootPath(),"src","main","resource"),fs_extra_1.default.existsSync(t)&&fs_extra_1.default.readdirSync(t).forEach((e=>{if("rawfile"!==e&&"resfile"!==e){const i=path_1.default.resolve(t,e,"element","string.json"),s=path_1.default.resolve(this.pathInfo.getResourceStr(),e,"element","string.json");let o;const n=(0,json_util_js_1.getJson5Obj)(i);o=fs_extra_1.default.existsSync(s)?(0,json_util_js_1.mergeStringJson)((0,json_util_js_1.getJson5Obj)(s),n):n,o&&fs_extra_1.default.outputFileSync(s,JSON.stringify(o))}}))}))}}function checkHarDeviceTypes(e,t){const i=e.module.deviceTypes,s=t.module.deviceTypes,o="default",n="phone";(s.includes(o)||s.includes(n))&&(s.push(n),s.push(o));const r=i.filter((e=>!s.includes(e)));if(r.length>0){const e=`The ${t.module.type} module '${t.module.name}' that the current module depends on does not support the device type: '${r.join(", ")}',\n      which may cause runtime exception on the device. Please confirm.`;_log.errorMessageExit(e)}}exports.MergeProfile=MergeProfile;