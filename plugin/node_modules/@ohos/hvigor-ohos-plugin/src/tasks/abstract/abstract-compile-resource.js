"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractCompileResource=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),log4js_1=require("log4js"),common_util_js_1=require("../../common/common-util.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),ohos_trace_js_1=require("../../common/trace/ohos-trace.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),inject_const_js_1=require("../../const/inject-const.js"),compile_resources_util_js_1=require("../../utils/compile-resources-util.js"),file_util_js_1=require("../../utils/file-util.js"),map_util_js_1=require("../../utils/map-util.js"),process_utils_js_1=require("../../utils/process-utils.js"),module_task_service_js_1=require("../service/module-task-service.js"),json_util_js_1=require("../../utils/json-util.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),abstract_resource_task_js_1=require("./abstract-resource-task.js");class AbstractCompileResource extends abstract_resource_task_js_1.AbstractResource{constructor(e,t){super(e,t),this.compileCommands=[],this.linkCommand=[],this.intermediatesResDir=this.pathInfo.getIntermediatesRes(),this.isPreview=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.BUILD_ROOT)===build_directory_const_js_1.BuildDirConst.PREVIEW_BUILD_PATH}getEnabled(){const e=this.node.getTaskContainer().findTask(`${this.targetName}@${this.processProfileTask}`);if(void 0===e)throw new Error(`Resource compile task initialize failed, task ${this.processProfileTask} not found.`);return this.restoolCommandBuilder=e.restoolCommandBuilder,this.restoolConfigBuilder=e.restoolConfigBuilder,super.getEnabled()}getCommand(){return[this.getResToolFile(),"-l",this.resConfigFilePath]}beforeTask(){file_util_js_1.FileUtil.checkDirWithoutDelete(this.intermediatesResDir),file_util_js_1.FileUtil.checkDirWithoutDelete(this.generateSourceRDir)}declareInputs(){const e=new Map;return this.isPreview&&(e.set("PREVIEWER_REPLACE_PAGE",JSON.stringify(hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.PREVIEWER_REPLACE_PAGE))),e.set("PREVIEWER_REPLACE_SRCPATH",JSON.stringify(hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.PREVIEWER_REPLACE_SRC_PATH)))),e.set("TARGET_CONFIG",JSON.stringify(this.targetData.getTargetOpt())),e}declareExecutionTool(){return this.getResToolFile()}declareInputFiles(){return this.restoolConfigBuilder.inputFiles}declareOutputFiles(){return this.restoolConfigBuilder.outputFiles.addEntries([this.intermediatesResDir,this.generateSourceRDir],{isDirectory:!0})}getResToolFile(){return this.sdkInfo.getRestool()}async compilationProcess(e,t){this.precheck(e)&&await this.invokeRestool(t)}precheck(e){var t;return e===compile_resources_util_js_1.CompileResourceBuildCommandType.FILE?this.restoolConfigBuilder.existsResourceDir:!!(null===(t=this.restoolCommandBuilder)||void 0===t?void 0:t.existsResourceDir)}async invokeRestool(e){}async executeCommand(e,t,o=wdk_1.noop,s){t._printDebugCommand(this.getResToolFile(),e);const i="execute compile resource command using restool",r=this.durationEvent.createSubEvent(i,"");r.start(),await new process_utils_js_1.ProcessUtils(this.moduleName,this.name).execute(e,s,void 0,((e,o)=>(this.restoolReportHandler(e),this.iconSizeWarningHandler(e,o,t)))),r.stop(),r.setLog(i,hvigor_1.MetricLogType.INFO),await o()}iconSizeWarningHandler(e,t,o){var s;if(!((null===(s=e.stderr)||void 0===s?void 0:s.length)>0))return!1;const i=e.stderr;return!(!/Warning: the png width and height not equal/.test(i)&&!/Warning: The width or height of the .+ file referenced by the icon exceeds the limit+./.test(i))&&(JSON.stringify(o.getLevel())===JSON.stringify(log4js_1.levels.DEBUG)&&o.warn(i),!0)}restoolReportHandler(e){var t,o,s,i;const r=(e.stdout+e.stderr).split("\n"),a=r.findIndex((e=>e.startsWith("Processing report:")));if(a>=0&&a+3<r.length){const e=/\d+\\.\d+|\d+/g,n=null===(o=null===(t=r[a+2])||void 0===t?void 0:t.match(e))||void 0===o?void 0:o.map((e=>parseFloat(e))),l=null===(i=null===(s=r[a+3])||void 0===s?void 0:s.match(e))||void 0===i?void 0:i.map((e=>parseFloat(e)));if(!Array.isArray(n)||!Array.isArray(l)||0===n[0]||0===l[2])return;const[u,_]=n,[c,d,m,h]=l;ohos_trace_js_1.ohosTrace.traceRestoolCompression(this.moduleModel.getName(),{TIMESTAMP:Date.now(),TRANSCODE_FILES:u,TRANSCODE_SUCCESS_RATE:c/u,TRANSCODE_TOTAL_TIME:_,TRANSCODE_EXPANSION_RATE:h/m})}}async compileLink(e,t=wdk_1.noop){for(const t of this.compileCommands)await this.executeCommand(t,e);await this.executeCommand(this.linkCommand,e,t)}getInputData(e){return{moduleName:this.moduleName,taskName:this.name,commandLine:e}}async previewCompileLink(e,t=wdk_1.noop){var o;const s="generate compilation link command",i=this.durationEvent.createSubEvent(s,"");i.start(),this.restoolLinkParamObj=null===(o=this.restoolCommandBuilder)||void 0===o?void 0:o.restoolLinkParamObj,await this.buildIncrementalCompileLinkFullCommand(),i.stop(),i.setLog(s,hvigor_1.MetricLogType.INFO),await this.compileLink(e,t),await this.previewBuildParamPersistence()}async previewBuildParamPersistence(){const e=this.restoolLinkParamObj.appScopeResources,t=this.restoolLinkParamObj.moduleResourcesMap,o=this.restoolLinkParamObj.harResourcesMap,s={APP_RESOURCES:e||"",MODULE_RESOURCES:JSON.stringify((0,map_util_js_1.strMapToObj)(t)),HAR_RESOURCES:JSON.stringify((0,map_util_js_1.strMapToObj)(o)),PREVIEW_GENERATE_SOURCE_DIR:this.pathInfo.getPreviewGenerateSourceR(),PREVIEW_COMPILE_MODULE_NAMES:compile_resources_util_js_1.CompileResourcesUtil.getRestoolModuleNames(this.service,this.targetName).join(",")},i=path_1.default.resolve(this.pathInfo.getModulePreviewPath(),build_directory_const_js_1.BuildArtifactConst.PREVIEW_BUILD_PARAM_JSON);await fs_extra_1.default.outputJSON(i,s)}async buildIncrementalCompileLinkFullCommand(){var e;this.linkCommand=this.restoolLinkParamObj.linkCommand,this.linkOutputPath=null===(e=this.restoolLinkParamObj)||void 0===e?void 0:e.outputPath;const t=this.restoolLinkParamObj.appScopeResources,o=this.restoolLinkParamObj.moduleResourcesMap,s=this.restoolLinkParamObj.harResourcesMap,i=this.restoolLinkParamObj.outputPath,r=this.restoolLinkParamObj.idsMapPath;await fs_extra_1.default.ensureDir(i);const a=(await fs_extra_1.default.readdir(i)).filter((e=>e!==build_directory_const_js_1.BuildDirConst.IDS_MAP));for(const e of a)await fs_extra_1.default.remove(path_1.default.resolve(i,e));if(t&&t.length>0){const e=path_1.default.resolve(this.linkOutputPath,build_directory_const_js_1.BuildDirConst.APP_COMPILED),o=[this.getResToolFile(),"-x",t,"-o",e];this.compileCommands.push(o),this.linkCommand.push("-i",e),file_util_js_1.FileUtil.checkDirWithoutDelete(e)}r&&file_util_js_1.FileUtil.checkDirWithoutDelete(r),this.linkCommandPushResourcesMap(o),this.linkCommandPushResourcesMap(s),this.linkCommand.push("-o",i)}linkCommandPushResourcesMap(e){e.size>0&&e.forEach(((e,t)=>{const o=path_1.default.resolve(this.linkOutputPath,e),s=[this.getResToolFile(),"-x",t,"-o",o];this.compileCommands.push(s),this.linkCommand.push("-i",o),fs_extra_1.default.existsSync(o)||fs_extra_1.default.mkdirsSync(o)}))}async retainDeviceType(e,t,o){var s,i,r,a;const n=e.findRelatedTargetData(t);if((0,module_task_service_js_1.checkHasTargetApplyProduct)(this.targetData.getModuleModel(),this.targetData.getTargetName(),this.targetData.getProduct().name)&&n){const l=n.getTargetDeviceType(),u=e.getTargetDeviceType().filter((e=>(null==l?void 0:l.indexOf(e))>-1)),_=path_1.default.resolve(e.getPathInfo().getIntermediatesRes(),t,common_const_js_1.CommonConst.CONFIG_JSON),c=(0,json_util_js_1.getJson5Obj)(_);if(c.module.deviceType=u,this.isFaMode){const e=this.service.getProjectModel(),o=e.getModuleModelByName(t),l=path_1.default.resolve(null!==(s=null==o?void 0:o.getProjectDir())&&void 0!==s?s:path_1.default.resolve(e.getProjectDir(),t),`src/main/${common_const_js_1.CommonConst.CONFIG_JSON}`),u=res_model_loader_js_1.resModelLoader.getConfigJson(l),_=null!==(r=null===(i=n.getTargetOpt().config)||void 0===i?void 0:i.distroFilter)&&void 0!==r?r:null===(a=null==u?void 0:u.module)||void 0===a?void 0:a.distroFilter;_&&(c.module.distroFilter=_)}await fs_extra_1.default.outputJson(_,c,{spaces:"\t"}),0===u.length&&o.warn(`The device types of ${this.moduleModel.getName()} and ${t} are different. Invalid HAP ${this.moduleModel.getName()}.`)}}replaceTargetPages(e,t){var o;const s=null===(o=e.getTargetOpt().source)||void 0===o?void 0:o.pages;void 0!==s&&this.replacePages(t,s)}customizeShortcut(){const e=this.targetData.getProduct(),t=this.moduleModel.getModule().getNodeDir(),o=path_1.default.resolve(t,`src/main/${common_const_js_1.CommonConst.MODULE_JSON5}`),s=res_model_loader_js_1.resModelLoader.getModuleJson(o).module.metadata,i=this.projectModel.getAppRes().getAppResOpt().app.bundleName;s&&0!==s.length&&s.forEach((o=>{if(!o.resource)return;const s=(0,common_util_js_1.parsingProfileName)(o.resource),r=path_1.default.resolve(t,`src/main/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}/${s}.json`),a=(0,json_util_js_1.getJson5Obj)(r).shortcuts;if(!a||0===a.length)return;const n=this.targetData.getTargetOpt().name,l=path_1.default.resolve(this.pathInfo.getModuleProductPath(),`intermediates/res/${n}/${build_directory_const_js_1.BuildDirConst.RESOURCES_BASE_PROFILE_DIR}/${s}.json`);a.forEach((t=>{const o=t,s=o.wants;s&&0!==s.length&&(s.forEach((t=>{var o;if(i===t.bundleName){const s=(0,wdk_1.cloneDeep)(null===(o=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===o?void 0:o.appOpt);if(null==s?void 0:s.bundleName)return void(t.bundleName=s.bundleName);e.bundleName&&(t.bundleName=e.bundleName)}})),fs_extra_1.default.existsSync(l)||fs_extra_1.default.createFileSync(l),fs_extra_1.default.writeJSONSync(l,{newShortCutObj:o}))}))}))}}exports.AbstractCompileResource=AbstractCompileResource;