"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,r)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.computeTargetTaskName=exports.TargetTaskService=void 0;const fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),common_util_js_1=require("../../common/common-util.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),aot_compile_mode_enum_js_1=require("../../enum/aot-compile-mode-enum.js"),build_mode_manager_js_1=require("../../project/build-option/build-mode-manager.js"),sdk_loader_js_1=require("../../sdk/sdk-loader.js"),cmake_util_js_1=require("../../utils/cmake-util.js"),file_util_js_1=require("../../utils/file-util.js"),inject_util_js_1=require("../../utils/inject-util.js"),json_util_js_1=require("../../utils/json-util.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),log_adaptor_js_1=require("../../utils/log/log-adaptor.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),validate_util_js_1=require("../../utils/validate/validate-util.js"),task_util_js_1=require("../../utils/task-util.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("Hvigor-target-service");class TargetTaskService{constructor(e,t){this.targetData=e,this.buildOption=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(e.getModuleModel().getName(),e.getTargetName()),this.moduleService=t;const o=e.getProduct(),i=this.moduleService.getProjectModel().getProfilePath(),r=(0,task_util_js_1.isAtomicServiceProject)(o,t.getProjectModel());validate_util_js_1.ValidateUtil.integrationVersionCheck(e.isHarmonyOS(),o,r,i),this._sdkInfo=sdk_loader_js_1.SdkLoader.getSdkInfo(this.targetData.getApiMeta().compileSdkVersion,!this.targetData.isHarmonyOS());const s=this.getBuildOption().externalNativeOptions;this.shouldBuildCmake=cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.targetData.getModuleModel(),this.targetData,s)}refreshBuildOption(){this.buildOption=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(this.targetData.getModuleModel().getName(),this.targetData.getTargetName())}buildTaskName(e,t){return{...e,name:`${computeTargetTaskName(null!=t?t:this.getTargetData().getTargetName(),e.name)}`}}getTargetData(){return this.targetData}getBuildOption(){return this.buildOption}isByteCodeHar(){var e,t,o;if(!this.moduleService.getModuleModel().isHarModule()||inject_util_js_1.InjectUtil.isInTest())return!1;const i=null===(t=null===(e=this.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl,r=null===(o=this.getBuildOption().arkOptions)||void 0===o?void 0:o.byteCodeHar;return this.getByteCodeHar(i,r)}getByteCodeHar(e,t){return!(!e||void 0!==t)||!(!e&&!t)&&!!t}isNoExternalImportByPath(){var e,t,o,i;const r=null===(t=null===(e=this.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl,s=null===(i=null===(o=this.buildOption)||void 0===o?void 0:o.strictMode)||void 0===i?void 0:i.noExternalImportByPath;return!(!r||void 0!==s)||!!s}isSourceCodeHar(){return this.moduleService.getModuleModel().isHarModule()&&!this.isByteCodeHar()}isBundledDependencies(){var e,t;return!!(null===(t=null===(e=this.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.bundledDependencies)}getNativeLibOption(){var e;return{...this.getBuildOption().nativeLib,filter:{...this.getBuildOption().napiLibFilterOption,...null===(e=this.getBuildOption().nativeLib)||void 0===e?void 0:e.filter}}}getWorkerConfig(){var e,t,o;return file_util_js_1.FileUtil.convertToAbsolutePaths(null!==(o=null===(t=null===(e=this.buildOption)||void 0===e?void 0:e.sourceOption)||void 0===t?void 0:t.workers)&&void 0!==o?o:[],this.moduleService.getModuleModel().getProjectDir())}getBuildProfileFields(){var e,t;return null===(t=null===(e=this.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.buildProfileFields}getResourceDirs(){var e;const t=null===(e=this.targetData.getTargetOpt().resource)||void 0===e?void 0:e.directories;if(!(null==t?void 0:t.length)){const e=path_1.default.resolve(this.targetData.getModuleSourceSetModel().getSourceSetRoot(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES);return fs_1.default.existsSync(e)?this.convertResourceAbsolutePath([e]):[]}return this.convertResourceAbsolutePath(t)}convertResourceAbsolutePath(e){return e.map((e=>{const t=path_1.default.isAbsolute(e)?e:path_1.default.resolve(this.moduleService.getModuleModel().getProjectDir(),e);return validate_util_js_1.ValidateUtil.validateTargetCustomizeResources(e,t),t}))}getAnBuildMode(){var e,t,o,i,r;const s=this.targetData.getCompileApiVersion(),l=null!==(o=null===(t=null===(e=this.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.aotCompileMode)&&void 0!==o?o:null===(i=this.getBuildOption())||void 0===i?void 0:i.aotCompileMode,a=null===(r=this.getBuildOption().arkOptions)||void 0===r?void 0:r.hostPGO;switch(s){case sdk_const_js_1.ApiVersion.API_VERSION_9:return null!=l?l:aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_NULL;case sdk_const_js_1.ApiVersion.API_VERSION_10:default:return!this._sdkInfo.isOhos||this._sdkInfo.checkAotFixedSdkVersion()||a?a?aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL:aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_TYPE:aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_NULL}}getApPath(){var e,t,o,i,r;return null!==(r=null!==(o=null===(t=null===(e=this.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.apPath)&&void 0!==o?o:null===(i=this.getBuildOption())||void 0===i?void 0:i.apPath)&&void 0!==r?r:this.targetData.getCompileApiVersion()>=sdk_const_js_1.ApiVersion.API_VERSION_10?"./modules.ap":void 0}getApAbsolutePath(){const e=this.getApPath(),t=this.targetData.getModuleModel().getProjectDir();return e?path_1.default.resolve(t,e):t}getCustomTypes(){var e,t;return null===(t=null===(e=this.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.types}isDebug(){const e=this.buildOption.debuggable;return void 0===e||e}isOpenSource(){var e,t,o,i;if(!this.isDebug()){const r=null===(i=null===(o=null===(t=null===(e=this.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.obfuscation)||void 0===o?void 0:o.ruleOptions)||void 0===i?void 0:i.enable;if(void 0===r||!r)return!0;if(r)return!1}return!0}getShouldBuildCmake(){return this.shouldBuildCmake}getBuildMode(){return this.isDebug()?"Debug":"Release"}needPackBin(e){return e.hasLiteDeviceInTarget()&&this.isDebug()&&!hvigor_1.hvigorCore.isCommandEntryTask(common_const_js_1.CommonConst.ASSEMBLE_APP)}getSdkInfo(){return this._sdkInfo}getModuleService(){return this.moduleService}static getFormJsonArr(e){var t;const o=e.getModuleJsonOpt(),i=e.getResourcePath(),r=e.getJsonPath(),s=[];return(null==o?void 0:o.module.extensionAbilities)?(null===(t=o.module.extensionAbilities)||void 0===t||t.forEach((e=>{var t;if("form"===e.type){if(!(null===(t=e.metadata)||void 0===t?void 0:t.length))return void _log.printErrorExit(new log_adaptor_js_1.OhosLogAdaptor("HE10313",hvigor_1.globalData.buildId).formatMessage(r).getLogMessage());const o=e.metadata.find((e=>"ohos.extension.form"===e.name));if(!(null==o?void 0:o.resource))return void _log.printErrorExit(new log_adaptor_js_1.OhosLogAdaptor("HE10312",hvigor_1.globalData.buildId).formatMessage(r).getLogMessage());for(const t of e.metadata)if(t.resource){"string"!=typeof t.resource&&_log.errorMessageExit(`metadata.resource must be string in file: ${r}`);const e=`${t.resource.replace(/\$profile:/,"")}.json`,o=path_1.default.resolve(i,build_directory_const_js_1.BuildDirConst.BASE,build_directory_const_js_1.BuildDirConst.PROFILE,e);this.formJsonFileCheck(o,t,r),s.push(o)}}})),s):s}static formJsonFileCheck(e,t,o){if(!fs_1.default.existsSync(e)){const e=fs_1.default.readFileSync(o).toString().split("\n");let i=-1,r=-1;e.some(((e,o)=>-1!==(r=e.indexOf(t.resource))&&(i=o,!0))),_log.errorMessageExit(`Cannot resolve symbol '${t.resource}'${os_1.default.EOL}\t at ${o}:${i+1}:${r+1+t.resource.length}`)}}getAppStartupPath(){const e=this.targetData.getModuleSourceSetModel(),t=res_model_loader_js_1.resModelLoader.getModuleJson(e.getModuleTargetRes().getJsonPath()).module.appStartup,o=(0,common_util_js_1.parsingProfileName)(t);if(o)return this.getTargetResourceBaseProfilePath(`${o}.json`)}getRouterMapJsonPath(e){const t=this.getRouterMapJsonFileName(e);if(t)return this.getTargetResourceBaseProfilePath(`${t}.json`)}getRouterMapJsonFileName(e){if(!e)return;const t=path_1.default.resolve(e.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,common_const_js_1.CommonConst.MODULE_JSON5),o=res_model_loader_js_1.resModelLoader.getModuleJson(t).module.routerMap;return(0,common_util_js_1.parsingProfileName)(o)}getTargetRouterMapObjList(e){const t=this.getRouterMapJsonPath(e);if(!t||!fse.existsSync(t))return;const o=(0,json_util_js_1.getJson5Obj)(t);return o.routerMap.forEach((t=>{Object.assign(t,{moduleNodeDir:e.getModule().getNodeDir()})})),null==o?void 0:o.routerMap}getTargetResourceBaseProfilePath(e){for(const t of this.getResourceDirs()){const o=path_1.default.resolve(t,common_const_js_1.CommonConst.BASE_PROFILE,e);if(fse.existsSync(o))return o}}}function computeTargetTaskName(e,t){return`${e}@${t}`}exports.TargetTaskService=TargetTaskService,exports.computeTargetTaskName=computeTargetTaskName;