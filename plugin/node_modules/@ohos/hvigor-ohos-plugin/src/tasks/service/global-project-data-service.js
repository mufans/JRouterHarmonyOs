"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GlobalProjectDataService=void 0;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),find_target_product_js_1=require("../../common/find-target-product.js"),common_const_js_1=require("../../const/common-const.js"),file_util_js_1=require("../../utils/file-util.js"),wdk_1=require("@baize/wdk"),integrated_hsp_utils_js_1=require("../../utils/integrated-hsp-utils.js"),json_util_js_1=require("../../utils/json-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohos_test_util_js_1=require("../../utils/ohos-test-util.js"),sign_util_js_1=require("../sign/sign-util.js"),hvigor_config_loader_1=require("@ohos/hvigor/src/common/util/hvigor-config-loader");class GlobalProjectDataService{constructor(){this.compileProjectModel={},this.allModulePaths=[],this.projectPkgJsonFileHash="",this.allModuleNameHash="",this.moduleRemoteHspSet=new Set,this.remoteHspCache={signingConfig:{},signedRemoteHsps:new Map},this._log=ohos_logger_js_1.OhosLogger.getLogger(GlobalProjectDataService.name)}static getInstance(){return GlobalProjectDataService.INSTANCE}initGlobalProjectData(e){this.compileProjectModel=this.initCompileProjectModel(e),this.allModuleNameHash=this.initAllModuleNameHash(e),this.allModulePaths=this.initAllModulePath(e),this.projectRemoteHspPromise=void 0,this.moduleRemoteHspSet=new Set,this.initRemoteHspCache(e),this.integratedHspUtils=new integrated_hsp_utils_js_1.IntegratedHspUtils(e)}getCompileProjectModel(){return this.compileProjectModel}setProjectPkgJsonFileHash(e){this.projectPkgJsonFileHash=e}getProjectPkgJsonFileHash(){return this.projectPkgJsonFileHash}getAllModuleNameHash(){return this.allModuleNameHash}setProjectRemoteHspPromise(e){this.projectRemoteHspPromise=e}getProjectRemoteHspPromise(){return this.projectRemoteHspPromise}setModuleRemoteHspPromise(e){this.moduleRemoteHspSet.add(e)}getModuleRemoteHspPromise(){return this.moduleRemoteHspSet}setNeedSignedRemoteHspMap(e,t){this.remoteHspCache.signedRemoteHsps.set(e,t)}getRemoteHspCache(){return this.remoteHspCache}needSignedRemoteHsp(e,t){if(this.remoteHspCache.signedRemoteHsps.has(e)){const o=this.remoteHspCache.signedRemoteHsps.get(e);return!!(null==o?void 0:o.moduleName)&&o.moduleName===t}return!0}changeRemoteHspSigned(e){for(const t of this.remoteHspCache.signedRemoteHsps.values())t.signedHspPath===e&&(t.isSigned=!0)}allRemoteHspSigned(){for(const e of this.remoteHspCache.signedRemoteHsps.values())if(!e.isSigned)return!1;return!0}getIntegratedHspUtils(){return this.integratedHspUtils}getAllModulePaths(){return this.allModulePaths}initCompileProjectModel(e){const t={};return e.getAllModules().forEach((o=>{var s,i;const r=null!==(s=hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.BUILD_CACHE_DIR))&&void 0!==s?s:hvigor_config_loader_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(common_const_js_1.CommonConst.BUILD_DIR_KEY),l=o.getProjectDir();for(const[s,a]of o.getAllTargetSourceSet()){const n=null!==(i=a.getTargetSourceSetModuleName())&&void 0!==i?i:o.getName(),g=a.getSourceSetRoot();if("ohosTest"===s&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(g)){const e=(0,ohos_test_util_js_1.getOhosTestIntermediatesEtsPath)(l);t[e]={moduleName:n,modulePkgPath:l,belongProjectPath:o.getBelongProjectPath()}}if(r&&fs_extra_1.default.existsSync(r)){const s=path_1.default.resolve(r,e.getName(),n,"build");t[s]={moduleName:n,modulePkgPath:l,belongProjectPath:o.getBelongProjectPath()}}t[g]={moduleName:n,modulePkgPath:l,belongProjectPath:o.getBelongProjectPath()}}t[l]={moduleName:o.getName(),modulePkgPath:l,belongProjectPath:o.getBelongProjectPath()}})),t[e.getProjectDir()]={moduleName:e.getName(),modulePkgPath:e.getProjectDir(),belongProjectPath:e.getProjectDir()},t}initProjectPkgJsonFileHash(e){var t;const o=e.isOhpmProject();let s=e.getAllModules().map((e=>{var t;const s=o?e.getOhPackageJson5Path():e.getPackageJsonPath();return null!==(t=file_util_js_1.FileUtil.readFile(s))&&void 0!==t?t:""})).join("");const i=o?e.getOhPackageJson5Path():e.getPackageJsonPath();return s+=null!==(t=file_util_js_1.FileUtil.readFile(i))&&void 0!==t?t:"",(0,hvigor_1.hash)(s)}initAllModuleNameHash(e){let t=e.getAllModules().map((e=>{var t;let o="";for(const[s,i]of e.getAllTargetSourceSet())o+=null!==(t=i.getTargetSourceSetModuleName())&&void 0!==t?t:e.getName();return o})).join("");return t+=e.getName(),(0,hvigor_1.hash)(t)}initAllModulePath(e){return e.getAllModules().map((e=>e.getProjectDir()))}resetRemoteHspCache(){this.remoteHspCache={signingConfig:{},signedRemoteHsps:new Map}}initRemoteHspCache(e){this.resetRemoteHspCache();const t=(0,find_target_product_js_1.findTargetProduct)(e),o=(0,sign_util_js_1.getSigningConfig)(e),s=e.getCacheRemoteHspPath(t.name),i=path_1.default.resolve(s,common_const_js_1.CommonConst.REMOTE_HSP_CACHE),r=new Map;if(o){if(fs_extra_1.default.existsSync(i)){const e=(0,json_util_js_1.getJson5Obj)(i);if((0,wdk_1.isEqual)(e.signingConfig,o)){const t=fs_extra_1.default.readdirSync(s);Object.keys(e.signedRemoteHsps).forEach((o=>{const s=e.signedRemoteHsps[o];t.includes(o)&&(null==s?void 0:s.signedHspPath)&&fs_extra_1.default.existsSync(s.signedHspPath)&&r.set(o,s)})),this.remoteHspCache.signedRemoteHsps=r}}this.remoteHspCache.signingConfig=o}else this._log.debug("No signingConfig found, initRemoteHspCache failed.")}}exports.GlobalProjectDataService=GlobalProjectDataService,GlobalProjectDataService.INSTANCE=new GlobalProjectDataService;