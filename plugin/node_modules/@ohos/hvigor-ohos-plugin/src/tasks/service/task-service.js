"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TaskService=void 0;const path_1=__importDefault(require("path")),dependency_interface_js_1=require("../../project/dependency/core/dependency-interface.js"),copy_resources_util_js_1=require("../../utils/copy-resources-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),remote_hsp_utils_js_1=require("../../utils/remote-hsp-utils.js"),build_directory_const_js_1=require("../../const/build-directory-const.js");class TaskService{constructor(e,n,t,p){this.log=ohos_logger_js_1.OhosLogger.getLogger("TaskService"),this.hvigorNode=e,this._projectModel=n,this._dependencyManager=t,this._isFaMode=p}initDependencyInfo(){this._moduleDependencyInfo=this._dependencyManager.createModelDependencyInfo()}isFaMode(){return this._isFaMode}getNode(){return this.hvigorNode}getProjectModel(){return this._projectModel}getDependencyMainPaths(){return this.getDependencyInfo().getNpmDependencies().map((e=>e.getDependencyMainFilePath()))}getDependencyRootPaths(){return this.getDependencyInfo().getNpmDependencies().map((e=>e.getDependencyRootPath()))}getDependencyName2RootPath(){const e=new Map;for(const n of this.getDependencyInfo().getNpmDependencies()){const t=n.getDependencyName();if(e.has(t))return!1;e.set(t,n.getDependencyRootPath())}return e}getHarDependencies(){return this.getDependencyInfo().getNpmDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR))}getRemoteHarDependencies(){return this.getHarDependencies().filter((e=>!e.isLocal()))}getHspDependencies(){return this.getDependencyInfo().getNpmDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP))}getHspOrByteCodeHarDependencies(){return this.getDependencyInfo().getNpmDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP||e.isByteCodeHarDependency()))}getSODependencies(){return this.getDependencyInfo().getAllDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_SO))}getOtherDependencies(){return this.getDependencyInfo().getAllDependencies().filter((e=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_OTHER))}getAllDependencies(){return this.getDependencyInfo().getAllDependencies()}getDirectDependencies(){var e;const n=this.getDependencyInfo(),t=n.getModulePkgNode().children.map((e=>e.npm)),p=null===(e=n.getProjectPkgNode())||void 0===e?void 0:e.children.map((e=>e.npm));let s=t;if(null==p?void 0:p.length){const e=new Set(t.map((e=>e.getDependencyName()))),n=p.filter((n=>!e.has(n.getDependencyName())));s=s.concat(n)}return s.filter((e=>e.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DEV_DEPENDENCIES))}getHspDependencyPaths(){return this.getHspDependencies().filter((e=>e.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES)).map((e=>e.getDependencyRootPath()))}getModuleDependencies(){return[...this.getDependencyInfo().getModuleDependencyMap().values()]}getModuleDependenciesPaths(){return this.getModuleDependencies().map((e=>e.getDependencyRootPath()))}getHarModuleDependencies(){return[...this.getDependencyInfo().getModuleDependencyMap().entries()].filter((([,e])=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR))}getHarModuleDependenciesWithRootPath(){const e=new Map;return this.getDependencyInfo().getModuleDependenciesByType(dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR).forEach((([n,t])=>{e.set(t.getDependencyRootPath(),[n,t])})),e}getHarModuleDependencyNames(){return this.getHarModuleDependencies().map((([e])=>e))}getHarModuleDependencyPaths(){return this.getHarModuleDependencies().map((([,e])=>e.getDependencyRootPath()))}getHspModuleDependencies(){return[...this.getDependencyInfo().getModuleDependencyMap().entries()].filter((([,e])=>e.getDependencyType()===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP))}getHspModuleDependencyNames(){return this.getHspModuleDependencies().map((([e])=>e))}getHspModuleDependencyPaths(){return this.getHspModuleDependencies().map((([,e])=>e.getDependencyRootPath()))}getHspModuleDependencyPathsWithOutDynamic(){return this.getHspModuleDependencies().filter((([,e])=>e.getDependencyEnum()!==dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES)).map((([,e])=>e.getDependencyRootPath()))}hasHspDependencies(){return this.getDependencyInfo().hasHspDependency()}getDependencyInfo(){return!this._moduleDependencyInfo&&this.initDependencyInfo(),this._moduleDependencyInfo}getOhpmDependencyInfo(){const e={};return this.getDependencyInfo().getNpmDependencies().forEach((n=>{e[n.getDependencyName()]={name:n.getPackageName(),version:n.getDependencyVersion(),dependencies:n.getDependencies(),packagePath:n.getDependencyRootPath()}})),e}getOhpmRemoteHspAllInfo(e,n,t){const p={},s=this._dependencyManager.collectAllDependencies().npmDependencies,d=(0,remote_hsp_utils_js_1.getRemoteHspPathMap)(e);return s.forEach((e=>{var s;if(e.isLocal()||e.getDependencyType()!==dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP)return;const c=this.getRemoteHspDirName(e.getDependencyRootPath()),o=d.get(e.getPackageName());if(!c)return void this.log.debug(`${e.getDependencyRootPath()} does not exist oh_modules.`);let i;const r=e.getPackageJsonObj(),a=path_1.default.resolve(e.getDependencyRootPath(),"libs");if(t){const t=path_1.default.resolve(this._projectModel.getCacheRemoteHspPath(null!=n?n:"default"),c,o?o.replace(build_directory_const_js_1.BuildArtifactExtension.DOT_HSP,`-signed${build_directory_const_js_1.BuildArtifactExtension.DOT_HSP}`):`${e.getPackageName()}-signed.hsp`);p[e.getDependencyName()]={name:e.getPackageName(),version:e.getDependencyVersion(),dependencies:e.getDependencies(),packagePath:e.getDependencyRootPath(),signedRemoteHspPath:t,soPath:a}}else i=(null===(s=null==r?void 0:r.metadata)||void 0===s?void 0:s.integratedHsp)?path_1.default.resolve(this._projectModel.getCacheIntegratedHspPath(null!=n?n:"default"),c,o||`${e.getPackageName()}.hsp`):path_1.default.resolve(this.hvigorNode.getNodeDir(),"oh_modules",".hsp",c,o||`${e.getPackageName()}.hsp`),p[e.getDependencyName()]={name:e.getPackageName(),version:e.getDependencyVersion(),dependencies:e.getDependencies(),packagePath:e.getDependencyRootPath(),remoteHspPath:i,soPath:a}})),p}getOhpmRemoteHspDependencies(e,n,t){const p=this.getOhpmRemoteHspAllInfo(e,n,t),s={};return Object.entries(p).forEach((([e,n])=>{s[e]=t?{name:n.name,version:n.version,dependencies:n.dependencies,packagePath:n.packagePath,signedRemoteHspPath:n.signedRemoteHspPath}:{name:n.name,version:n.version,dependencies:n.dependencies,packagePath:n.packagePath,remoteHspPath:n.remoteHspPath}})),s}getRemoteHspDirName(e){const n=(0,copy_resources_util_js_1.toUnixPath)(e).split("/"),t=n.lastIndexOf("oh_modules");if(t>0)return n[t-1]}}exports.TaskService=TaskService;