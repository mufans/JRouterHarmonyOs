"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProjectTaskService=void 0;const hvigor_1=require("@ohos/hvigor"),path_1=__importDefault(require("path")),util_1=__importDefault(require("util")),find_target_product_js_1=require("../../common/find-target-product.js"),project_path_info_iml_js_1=require("../../common/iml/project-path-info-iml.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),abstract_hap_module_plugin_js_1=require("../../plugin/common/abstract-hap-module-plugin.js"),ohos_plugin_id_js_1=require("../../plugin/common/ohos-plugin-id.js"),hsp_plugin_1=require("../../plugin/hsp-plugin"),build_mode_manager_js_1=require("../../project/build-option/build-mode-manager.js"),project_extra_info_service_js_1=require("../../project/project-extra-info-service.js"),sdk_loader_js_1=require("../../sdk/sdk-loader.js"),array_util_js_1=require("../../utils/array-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_service_js_1=require("./task-service.js"),task_util_1=require("@ohos/hvigor/src/base/util/task-util"),global_project_data_service_js_1=require("./global-project-data-service.js"),ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET;class ProjectTaskService extends task_service_js_1.TaskService{constructor(e,t,o,r){super(e,t,o,r),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProjectTaskService.name),this._targetProduct=(0,find_target_product_js_1.findTargetProduct)(t);const i=project_extra_info_service_js_1.ProjectExtraInfoService.getProjectRuntimeOS(t)===runtime_type_enum_js_1.RuntimeTypeEnum.OpenHarmony,s=t.getCompileApiMetaByProduct(this._targetProduct.name);this._sdkInfo=sdk_loader_js_1.SdkLoader.getSdkInfo(s,i),this._pathInfo=new project_path_info_iml_js_1.ProjectPathInfoIml(t,this._targetProduct.name),this._productDataMap=new Map,this._buildOption=build_mode_manager_js_1.buildOptionManager.getProductBuildOption(this._targetProduct.name),global_project_data_service_js_1.GlobalProjectDataService.getInstance().initGlobalProjectData(t)}async setup(){var e,t,o;await this._sdkInfo.setup(),process.env.OHOS_SDK_NATIVE=this._sdkInfo.getSdkNativeDir();hvigor_1.MetricFactory.createMarkEvent("sdkVersion",null!==(e=this._sdkInfo.getToolchainsComponentVersion())&&void 0!==e?e:"").setMarkType(hvigor_1.MarkEventType.OTHER);if(null===(o=null===(t=this._targetProduct.buildOption)||void 0===t?void 0:t.strictMode)||void 0===o?void 0:o.caseSensitiveCheck){hvigor_1.MetricFactory.createMarkEvent("caseSensitiveCheckOn","caseSensitiveCheck check is on").setMarkType(hvigor_1.MarkEventType.OTHER)}else{hvigor_1.MetricFactory.createMarkEvent("caseSensitiveCheckOff","caseSensitiveCheck check is off").setMarkType(hvigor_1.MarkEventType.OTHER)}}getSdkInfo(){return this._sdkInfo}refreshData(){this._productDataMap.clear(),this.initProductData(),this._targetProduct=(0,find_target_product_js_1.findTargetProduct)(this._projectModel)}initProductData(){const e=this.hvigorNode;null==e||e.getSubModules().forEach((e=>{var t,o;const r=e.getName(),i=null!==(t=e.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HAP_PLUGIN))&&void 0!==t?t:e.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HSP_PLUGIN),s=[];if(void 0!==i&&(i instanceof abstract_hap_module_plugin_js_1.AbstractHapModulePlugin||i instanceof hsp_plugin_1.HspPlugin)){const e=null===(o=this._projectModel)||void 0===o?void 0:o.getModuleProfileOpt(r),t=null==e?void 0:e.targets,a=i.getTaskService().getTargetDataSet(),_=new Set;a.forEach((e=>{_.add(e[0].getTargetName());void 0!==(0,array_util_js_1.getElementFromArr)(t,e[0].getTargetName())&&(this.checkIsOhosTestTarget(e[0]),e[1]&&s.push(e[0]))})),this.checkTargetIsUnknown(_,t),0!==s.length&&this._productDataMap.set(r,s)}}))}getProductDataMap(){return this._productDataMap}getPathInfo(){return this._pathInfo}getTargetProduct(){return this._targetProduct}getBuildOption(){return this._buildOption}getAppOutputFileName(e=!1){var t;const o=e?"signed":"unsigned",r=this._projectModel.getName(),i=null===(t=this._targetProduct.output)||void 0===t?void 0:t.artifactName;return`${i?`${i}${e?"":"-unsigned"}`:`${r}-${this._targetProduct.name}-${o}`}${build_directory_const_js_1.BuildArtifactExtension.DOT_APP}`}checkIsOhosTestTarget(e){if(e.getTargetName()!==ohosTestTargetName)return;const t=`Delete the 'ohosTest' configuration from the 'targets' field in the '${e.getModuleModel().getModule().getName()}' module in the build_profile.json5 file.`;this._log._buildError("The 'ohosTest' target does not need to be packaged into the application. 'ohosTest' target cannot be applied to product")._solution(t)._file(this._projectModel.getProfilePath())._printErrorAndExit()}checkTargetIsUnknown(e,t){var o;if(t&&!(0,task_util_1.getAlignTarget)())for(const r of t)e.has(r.name)||this._log._buildError(`Unknown target '${r.name}'.`)._solution(`Check the value of name under the targets tag of the module: ${util_1.default.format(r)}.`)._file(path_1.default.resolve(null===(o=this._projectModel)||void 0===o?void 0:o.getProjectDir(),common_const_js_1.CommonConst.PROFILE_JSON5))._printErrorAndExit()}}exports.ProjectTaskService=ProjectTaskService;