"use strict";var __importDefault=this&&this.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.matchErrorMessage=exports.HvigorGlobalErrorAdaptor=exports.HvigorLogAdaptor=void 0;const util_1=__importDefault(require("util")),path_const_js_1=require("../../../common/const/path-const.js"),json_reader_js_1=require("../../util/json-reader.js"),log_message_js_1=require("../log-message.js"),os_country_js_1=require("../../../common/os-country.js");class HvigorLogAdaptor{constructor(s,e){var o;if(this.logMessage=new log_message_js_1.LogMessage(new Date,e),""===s)return;const t=findErrorWithErrorCodeJson(s,this.getErrorCodeJsonPath()),r=(0,os_country_js_1.getOsLanguage)();t&&(this.logMessage.message=t.message,this.logMessage.originMessage=t.message,this.logMessage.solutions=t.solutions,this.logMessage.originSolutions=t.solutions,this.logMessage.moreInfo=null===(o=t.moreInfo)||void 0===o?void 0:o[r],this.logMessage.code=t.errorCode,this.logMessage.checkMessage=t.checkMessage)}getLogMessage(){return this.logMessage}getErrorCodeJsonPath(){return path_const_js_1.ERROR_CODE_JSON_PATH}formatMessage(...s){return this.logMessage.message=util_1.default.format(this.logMessage.message,...s),this}formatSolutions(s,...e){return this.logMessage.solutions&&(this.logMessage.solutions[s]=util_1.default.format(this.logMessage.solutions[s],...e)),this}}exports.HvigorLogAdaptor=HvigorLogAdaptor;class HvigorGlobalErrorAdaptor extends HvigorLogAdaptor{constructor(s,e){s.includes("JS heap out of memory")?super("HE10103",e):s.includes("properties of undefined")?(super("HE10104",e),this.formatMessage(s)):(super("",e),s.includes("Solutions:")?s.includes("BundleTool")?this.packingToolAdaptor(s):this.toolAdaptor(s):this.getLogMessage().message=s)}packingToolAdaptor(s){let e="";s.split("\r\n").forEach((s=>{if(s.includes("Solutions")){const e=s.split("Solutions:");e.length>=2&&(this.getLogMessage().solutions=e[1].split(">").map((s=>s.trimEnd().trim())).filter((s=>s.length>0)))}else e+=`${s}\r\n`})),this.getLogMessage().message=e.trimEnd(),this.setToolInfo()}toolAdaptor(s){const e=s.split("Solutions:");this.getLogMessage().message=e[0].trimEnd(),this.getLogMessage().solutions=e[1].split(">").map((s=>s.trimEnd().trim())).filter((s=>s.length>0)),this.checkEs2abc(),this.setToolInfo()}setToolInfo(){const s=this.getLogMessage(),e=matchErrorMessage(s.message,path_const_js_1.ERROR_CODE_JSON_PATH),o=(0,os_country_js_1.getOsLanguage)();e&&(s.moreInfo=e.moreInfo[o],s.components=e.error_components,s.checkMessage=e.checkMessage)}checkEs2abc(){this.getLogMessage().message;const s=this.getLogMessage().solutions;if(s&&s[(null==s?void 0:s.length)-1].includes("The size of programs is expected to be")){const e=s[(null==s?void 0:s.length)-1],o=e.indexOf("The size of programs is expected");s[(null==s?void 0:s.length)-1]=e.substring(0,o)+"\n\n"+e.substring(o),this.getLogMessage().solutions=s}}}function findErrorWithErrorCodeJson(s,e){return json_reader_js_1.JsonReader.getJsonObj(e).hvigorErrorCodes.find((e=>e.errorCode===s))}function matchErrorMessage(s,e){return json_reader_js_1.JsonReader.getJsonObj(e).errorMessages.find((e=>s.includes(e.checkMessage)))}exports.HvigorGlobalErrorAdaptor=HvigorGlobalErrorAdaptor,exports.matchErrorMessage=matchErrorMessage;